// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.11/esri/copyright.txt for details.
//>>built
require({cache:{"esri/layers/FeatureEditResult":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel"],function(g,n,r,p){g=g(null,{declaredClass:"esri.layers.FeatureEditResult",constructor:function(l){l&&n.isObject(l)&&(this.objectId=l.objectId,this.success=l.success,l.success||(l=l.error,this.error=Error(),this.error.code=l.code,this.error.message=l.description))}});r("extend-esri")&&n.setObject("layers.FeatureEditResult",g,p);return g})},"esri/layers/MapImageLayer":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/dom-construct dojo/dom-style ../kernel ../config ../sniff ../domUtils ../geometry/Point ../geometry/webMercatorUtils ./layer".split(" "),
function(g,n,r,p,l,f,s,e,a,d,c,b,k){var m=g([k],{declaredClass:"esri.layers.MapImageLayer","-chains-":{constructor:"manual"},constructor:function(b){this.inherited(arguments,[null,b]);this._mapImages=[];var h=r.hitch;this._panStart=h(this,this._panStart);this._pan=h(this,this._pan);this._extentChange=h(this,this._extentChange);this._zoom=h(this,this._zoom);this._zoomStart=h(this,this._zoomStart);this._scale=h(this,this._scale);this._resize=h(this,this._resize);n.connect(this,"onSuspend",this,this._onSuspend);
n.connect(this,"onResume",this,this._onResume);this.loaded=!0;this.onLoad(this)},opacity:1,addImage:function(b){var h=this._mapImages.push(b),h=h-1;b._idx=h;b._layer=this;this._div&&this._createImage(b,h)},removeImage:function(b){if(b){var h=b._idx,q=this._mapImages;if(q[h]===b){delete q[h];if(h=b._node)this._clearEvents(h),h.e_idx=h.e_bl=h.e_tr=h.e_l=h.e_t=h.e_w=h.e_h=null,h.parentNode&&(h.parentNode.removeChild(h),l.destroy(h));b._node=b._idx=b._layer=null}}},removeAllImages:function(){var b=this._mapImages,
h,q=b.length;for(h=0;h<q;h++){var c=b[h];c&&this.removeImage(c)}this._mapImages=[]},getImages:function(){var b=this._mapImages,h=[],q,c=b.length;for(q=0;q<c;q++)b[q]&&h.push(b[q]);return h},setOpacity:function(b){this.opacity!=b&&(this._opacityChanged(this.opacity=b),this.onOpacityChange())},onOpacityChange:function(){},_opacityChanged:function(b){var h=this._div,c,k;if(h)if(!a("ie")||8<a("ie"))f.set(h,"opacity",b);else{k=h.childNodes;c=k.length;for(h=0;h<c;h++)f.set(k[h],"opacity",b)}},_createImage:function(b,
h){var c=l.create("img");f.set(c,{position:"absolute"});8>=a("ie")&&f.set(c,"opacity",this.opacity);b.rotation&&!(9>a("ie"))&&f.set(c,s._css.names.transform,s._css.rotate(360-b.rotation));b._node=c;c.e_idx=h;c.e_layer=this;c.e_load=n.connect(c,"onload",m.prototype._imageLoaded);c.e_error=n.connect(c,"onerror",m.prototype._imageError);c.e_abort=n.connect(c,"onabort",m.prototype._imageError);c.src=b.href},_imageLoaded:function(b,h){var c=h||b.target||b.currentTarget,a=c.e_layer,k=a._mapImages[c.e_idx],
m=a._map;m&&(m.__zooming||m.__panning||!a._sr)?a._standby.push(c):(a._clearEvents(c),k&&k._node===c&&m&&a._attach(k))},_imageError:function(b){b=b.target||b.currentTarget;var h=b.e_layer,c=h._mapImages[b.e_idx];h._clearEvents(b);c&&(c._node=null)},_clearEvents:function(b){var h=n.disconnect;h(b.e_load);h(b.e_error);h(b.e_abort);b.e_load=b.e_error=b.e_abort=b.e_layer=null},_attach:function(a){var h=a.extent,q=h.spatialReference,k=this._sr,m=this._div,d=a._node,f=new c({x:h.xmin,y:h.ymin,spatialReference:q}),
h=new c({x:h.xmax,y:h.ymax,spatialReference:q});k.equals(q)||(k.isWebMercator()&&4326===q.wkid?(f=b.geographicToWebMercator(f),h=b.geographicToWebMercator(h)):q.isWebMercator()&&4326===k.wkid&&(f=b.webMercatorToGeographic(f),h=b.webMercatorToGeographic(h)));d.e_bl=f;d.e_tr=h;a.visible&&(this._setPos(d,m._left,m._top),(this._active||m).appendChild(d))},_setPos:function(b,h,c){var a=b.e_bl,k=b.e_tr,m=this._map,a=m.toScreen(a),k=m.toScreen(k);h=a.x-h;c=k.y-c;var d=Math.abs(k.x-a.x),a=Math.abs(a.y-k.y),
k={width:d+"px",height:a+"px"},e=this._mapImages[b.e_idx];"css-transforms"===m.navigationMode?k[s._css.names.transform]=s._css.translate(h,c)+(e.rotation?" "+s._css.rotate(360-e.rotation):""):(k.left=h+"px",k.top=c+"px");f.set(b,k);b.e_l=h;b.e_t=c;b.e_w=d;b.e_h=a},managedSuspension:!0,_setMap:function(b,h){this.inherited(arguments);var c=this._div=l.create("div",null,h),k=s._css.names,m={position:"absolute"},e=b.__visibleDelta;if(!a("ie")||8<a("ie"))m.opacity=this.opacity;"css-transforms"===b.navigationMode?
(m[k.transform]=s._css.translate(e.x,e.y),f.set(c,m),c._left=e.x,c._top=e.y,m={position:"absolute",width:b.width+"px",height:b.height+"px",overflow:"visible"},this._active=l.create("div",null,c),f.set(this._active,m),this._passive=l.create("div",null,c),f.set(this._passive,m)):(c._left=0,c._top=0,f.set(c,m));this._standby=[];k=this._mapImages;e=k.length;for(m=0;m<e;m++){var g=k[m];g._node||this._createImage(g,g._idx)}d.hide(c);return c},_unsetMap:function(b,c){this._disconnect();var a=this._div;if(a){var k=
this._mapImages,m,d=k.length;for(m=0;m<d;m++){var f=k[m];if(f){var e=f._node;e&&(this._clearEvents(e),e.e_idx=e.e_bl=e.e_tr=e.e_l=e.e_t=e.e_w=e.e_h=null);f._node=null}}c.removeChild(a);l.destroy(a)}this._map=this._div=this._sr=this._active=this._passive=this._standby=null;this.inherited(arguments)},_onSuspend:function(){this._disconnect();d.hide(this._div)},_onResume:function(b){b.firstOccurrence&&(this._sr=this._map.spatialReference,this._processStandbyList());b=this._map;var c=this._div,a=b.__visibleDelta;
"css-transforms"===b.navigationMode&&(c._left=a.x,c._top=a.y,f.set(c,s._css.names.transform,s._css.translate(c._left,c._top)));this._redraw("css-transforms"===b.navigationMode);this._connect(b);d.show(c)},_connect:function(b){if(!this._connections){var c=n.connect,a="css-transforms"===b.navigationMode;this._connections=[c(b,"onPanStart",this._panStart),c(b,"onPan",this._pan),c(b,"onExtentChange",this._extentChange),a&&c(b,"onZoomStart",this._zoomStart),a?c(b,"onScale",this._scale):c(b,"onZoom",this._zoom),
a&&c(b,"onResize",this._resize)]}},_disconnect:function(){this._connections&&(p.forEach(this._connections,n.disconnect),this._connections=null)},_panStart:function(){this._panL=this._div._left;this._panT=this._div._top},_pan:function(b,c){var a=this._div;a._left=this._panL+c.x;a._top=this._panT+c.y;"css-transforms"===this._map.navigationMode?f.set(a,s._css.names.transform,s._css.translate(a._left,a._top)):f.set(a,{left:a._left+"px",top:a._top+"px"})},_extentChange:function(b,c,a){a?this._redraw("css-transforms"===
this._map.navigationMode):c&&this._pan(b,c);this._processStandbyList()},_processStandbyList:function(){var b,c=this._standby;if(c&&c.length)for(b=c.length-1;0<=b;b--)this._imageLoaded(null,c[b]),c.splice(b,1)},_redraw:function(b){if(b){b=this._passive;var c=s._css.names;f.set(b,c.transition,"none");this._moveImages(b,this._active);f.set(b,c.transform,"none")}b=this._active||this._div;var c=this._div._left,a=this._div._top,k,m=b.childNodes.length,d;for(k=0;k<m;k++)d=b.childNodes[k],this._setPos(d,
c,a)},_zoom:function(b,c,a){b=this._div;var k=b._left,m=b._top,d,e=b.childNodes.length,l;for(d=0;d<e;d++){l=b.childNodes[d];var g=l.e_w*c,n=l.e_h*c,s=(a.x-k-l.e_l)*(g-l.e_w)/l.e_w,r=(a.y-m-l.e_t)*(n-l.e_h)/l.e_h,s=isNaN(s)?0:s,r=isNaN(r)?0:r;f.set(l,{left:l.e_l-s+"px",top:l.e_t-r+"px",width:g+"px",height:n+"px"})}},_zoomStart:function(){this._moveImages(this._active,this._passive)},_moveImages:function(b,c){var a=b.childNodes,k;k=a.length;if(0<k)for(k-=1;0<=k;k--)c.appendChild(a[k])},_scale:function(b,
c){var a=s._css.names,k=this._passive;f.set(k,a.transition,c?"none":a.transformName+" "+e.defaults.map.zoomDuration+"ms ease");s._css.matrix(b);f.set(k,a.transform,s._css.matrix(b))},_resize:function(b,c,a){f.set(this._active,{width:c+"px",height:a+"px"});f.set(this._passive,{width:c+"px",height:a+"px"})}});a("extend-esri")&&r.setObject("layers.MapImageLayer",m,s);return m})},"esri/layers/OnDemandMode":function(){define("dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/has ../kernel ../geometry/Point ../tasks/query ./RenderMode ./GridLayout".split(" "),
function(g,n,r,p,l,f,s,e,a,d){g=g([a],{declaredClass:"esri.layers._OnDemandMode",constructor:function(c){this.featureLayer=c;this._featureMap={};this._queryErrorHandler=r.hitch(this,this._queryErrorHandler)},initialize:function(c){this.inherited(arguments);var b=this.featureLayer,a=b._srInfo;this._gridLayer=new d(new s(a?a.valid[0]:c.extent.xmin,c.extent.ymax,c.spatialReference),{width:b._tileWidth,height:b._tileHeight},{width:c.width,height:c.height},a);this._cellMap={};this._gridLayer.setResolution(c.extent)},
startup:function(){this._ioQueue=[];this.featureLayer.suspended||(this._zoomHandler(),this._enableConnectors())},propertyChangeHandler:function(c){this._init&&(2>c?this._zoomHandler():console.log("FeatureLayer: layer in on-demand mode does not support time definitions. Layer id \x3d "+this.featureLayer.id+", Layer URL \x3d "+this.featureLayer.url))},destroy:function(){this._disableConnectors();this.inherited(arguments)},drawFeature:function(c){var b=this._gridLayer,a=c.geometry,m=[];if(a)for(var m=
b.getCellsInExtent("point"===a.type?{xmin:a.x,ymin:a.y,xmax:a.x,ymax:a.y}:a.getExtent(),!1).cells,b=this._cellMap,d,h=c.attributes[this.featureLayer.objectIdField],q,e,f,a=0;a<m.length;a++)d=m[a],q=d.latticeID,e=d.row,f=d.col,q?d=b[q]=b[q]||d:(b[e]=b[e]||{},d=b[e][f]=b[e][f]||d),d.features=d.features||[],d.features.push(c),this._addFeatureIIf(h,c),this._incRefCount(h)},suspend:function(){this._init&&this._disableConnectors()},resume:function(){this._init&&(this._enableConnectors(),this._zoomHandler())},
refresh:function(){this._zoomHandler()},_enableConnectors:function(){var c=this.map;this._zoomConnect=n.connect(c,"onZoomEnd",this,this._zoomHandler);this._panConnect=n.connect(c,"onPanEnd",this,this._panHandler);this._resizeConnect=n.connect(c,"onResize",this,this._panHandler)},_disableConnectors:function(){n.disconnect(this._zoomConnect);n.disconnect(this._panConnect);n.disconnect(this._resizeConnect)},_zoomHandler:function(){this._processIOQueue(!0);var c=this.featureLayer,b=this.map;c.suspended||
(c._fireUpdateStart(),this._clearIIf(),(c=c._trackManager)&&c.clearTracks(),this._cellMap={},this._gridLayer.setResolution(b.extent),this._sendRequest())},_panHandler:function(c){this.featureLayer._fireUpdateStart();this._sendRequest(this.featureLayer._resized&&c)},_getRequestId:function(c,b){return("_"+c.name+c.layerId+c._ulid+"_"+b.resolution+"_"+(b.latticeID||b.row+"_"+b.col)).replace(/[^a-zA-Z0-9\_]+/g,"_")},_sendRequest:function(c){this._exceeds=!1;var b=this.featureLayer,a=this.map;c=c||a.extent;
a=this._gridLayer.getCellsInExtent(c,b.latticeTiling).cells;if(!b.isEditable())var m=this._cellMap,a=p.filter(a,function(b){if(b.lattice){if(m[b.latticeID])return!1}else if(m[b.row]&&m[b.row][b.col])return!1;return!0});var d=b.getOutFields(),h=b.getDefinitionExpression(),q=b._getOffsettedTE(b._mapTimeExtent),f=b.supportsAdvancedQueries?b.getOrderByFields():null,l=b._usePatch,g=this._ioQueue,n,s=this,r=this._drawFeatures,w,u,x;this._pending=this._pending||0;for(n=0;n<a.length;n++){w=a[n];u=new e;u.geometry=
w.extent||w.lattice;u.outFields=d;u.where=h;b.latticeTiling&&w.extent&&(u.spatialRelationship=e.SPATIAL_REL_CONTAINS);u.returnGeometry=!0;u.timeExtent=q;u.maxAllowableOffset=b._maxOffset;b._ts&&(u._ts=(new Date).getTime());u.orderByFields=f;u.multipatchOption=b.multipatchOption;x=null;if(l&&(x=this._getRequestId(b,w),this._isPending(x)))continue;this._pending++;g.push(b._task.execute(u,function(){var b=w;return function(c){r.apply(s,[c,b])}}.call(this),this._queryErrorHandler,x))}this._removeOldCells(c);
this._endCheck()},_drawFeatures:function(c,b){this._exceeds=this._exceeds||c.exceededTransferLimit;this._finalizeIO();var a=this.map.extent,m=b.extent,d=b.row,h=b.col,q=this.featureLayer.objectIdField,e=c.features,f=this._gridLayer,l=this._cellMap,g=b.latticeID,n=g?l[g]:l[d]&&l[d][h];if(b.resolution!=f._resolution||(g?g!==f.getLatticeID(a):!f.intersects(m,a)))n&&this._removeCell(d,h,g);else if(n)this._updateCell(n,e);else{b.features=e;g?l[g]=b:(l[d]=l[d]||{},l[d][h]=b);m=e.length;for(a=0;a<m;a++)d=
e[a],h=d.attributes[q],this._addFeatureIIf(h,d),this._incRefCount(h)}this._endCheck()},_queryErrorHandler:function(c){this._finalizeIO();this.featureLayer._errorHandler(c);this._endCheck(!0)},_finalizeIO:function(){this._purgeRequests();this._pending--},_endCheck:function(c){if(0===this._pending){this._processIOQueue();var b=this.featureLayer,a=b._trackManager;a&&(a.clearTracks(),a.addFeatures(b.graphics),b._ager&&p.forEach(b.graphics,function(c){c._shape&&b._repaint(c)}),a.moveLatestToFront(),a.drawTracks());
this.featureLayer._fireUpdateEnd(c&&Error("FeatureLayer: an error occurred while updating the layer"),this._exceeds?{queryLimitExceeded:!0}:null);if(this._exceeds)b.onQueryLimitExceeded()}},_processIOQueue:function(c){this._ioQueue=p.filter(this._ioQueue,function(b){return-1<b.fired?!1:!0});c&&p.forEach(this._ioQueue,this._cancelPendingRequest)},_removeOldCells:function(c){var b=this._cellMap,a=this._gridLayer,d,e;for(d in b)if(b[d]){var h=b[d],q=h.latticeID,f=0,l=0;if(q)f++,q!==a.getLatticeID(c)&&
(this._removeCell(null,null,q),l++);else for(e in h)h[e]&&(f++,a.intersects(h[e].extent,c)||(this._removeCell(d,e),l++));l===f&&delete b[d]}},_updateCell:function(c,b){var a=this.featureLayer,d=a.objectIdField,a=a._selectedFeatures,e,h=b.length;c.features=c.features||[];for(e=0;e<h;e++){var q=b[e],f=q.attributes[d],l=this._addFeatureIIf(f,q);l===q?(this._incRefCount(f),c.features.push(l)):f in a||(l.setGeometry(q.geometry),l.setAttributes(q.attributes))}},_removeCell:function(c,b,a){var d=this._cellMap,
e=this.featureLayer,h=e.objectIdField,q=a?d[a]:d[c]&&d[c][b];if(q){a?delete d[a]:delete d[c][b];c=q.features;for(b=0;b<c.length;b++)a=c[b].attributes[h],this._decRefCount(a),a in e._selectedFeatures||this._removeFeatureIIf(a)}}});l("extend-esri")&&r.setObject("layers._OnDemandMode",g,f);return g})},"esri/layers/TrackManager":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../graphic ../geometry/Polyline ./GraphicsLayer".split(" "),function(g,n,r,p,l,f,s,e){g=
g(null,{declaredClass:"esri.layers._TrackManager",constructor:function(a){this.layer=a;this.trackMap={};this.trackLineMap={}},initialize:function(a){this.map=a;var d=this.layer,c=d._getRenderer(),c=c&&c.trackRenderer;if("esriGeometryPoint"===d.geometryType){var b=this.container=new e._GraphicsLayer({id:d.id+"_tracks",_child:!0});b.loaded=!0;b.onLoad(b);b._setMap(a,d._div);b.setRenderer(c)}},addFeatures:function(a){var d=this.trackMap,c=this.layer,b=c._trackIdField,k=[];r.forEach(a,function(c){var a=
c.attributes[b];(d[a]=d[a]||[]).push(c);-1===r.indexOf(k,a)&&k.push(a)});var m=c._startTimeField,e=c.objectIdField,h=function(b,c){var a=b.attributes[m],h=c.attributes[m];return a===h?b.attributes[e]<c.attributes[e]?-1:1:a<h?-1:1};r.forEach(k,function(b){d[b].sort(h)})},trimTracks:function(a){function d(a){for(a=c[a]||[];a.length>b;)k.push(a.shift())}var c=this.trackMap,b=this.layer.maximumTrackPoints||0,k=[],m;if(!b)return k;if(a)r.forEach(a,function(b){d(b)});else for(m in c)c.hasOwnProperty(m)&&
d(m);return k},drawTracks:function(a){function d(a){var h=k[a],d,l,g;l=c.trackLineMap[a];b.remove(l);delete c.trackLineMap[a];if(!h||2>h.length)return!1;l=[];for(d=h.length-1;0<=d;d--)(g=h[d].geometry)&&l.push([g.x,g.y]);h={};h[e]=a;1<l.length&&(l=new f(new s({paths:[l],spatialReference:m}),null,h),b.add(l),c.trackLineMap[a]=l)}var c=this,b=this.container,k,m,e,h;if(b)if(k=this.trackMap,m=this.map.spatialReference,e=this.layer._trackIdField,a)r.forEach(a,function(b){d(b)});else for(h in k)k.hasOwnProperty(h)&&
d(h)},refreshTracks:function(a){function d(a){var d,e;c.drawTracks([a]);if(m&&m.latestObservationRenderer){a=b[a]||[];d=a.length;for(e=0;e<d;e++)k._repaint(a[e],null,!0)}}var c=this,b=this.trackMap,k=this.layer,m=k._getRenderer(),e;if(a)r.forEach(a,function(b){d(b)});else for(e in b)b.hasOwnProperty(e)&&d(e);this.moveLatestToFront()},moveLatestToFront:function(a){r.forEach(this.getLatestObservations(a),function(a){var c=a._shape;c&&c._moveToFront();this._repaint(a,null,!0)},this.layer)},getLatestObservations:function(a){function d(b){b=
k[b];return b[b.length-1]}var c=[],b=this.layer._getRenderer(),k=this.trackMap,m;if(!b.latestObservationRenderer)return c;if(a)r.forEach(a,function(b){c.push(d(b))});else for(m in k)k.hasOwnProperty(m)&&c.push(d(m));return c},clearTracks:function(a){var d=this.getLatestObservations(a),c=this.container,b;a?r.forEach(a,function(a){delete this.trackMap[a];c&&(b=this.trackLineMap[a],c.remove(b),delete this.trackLineMap[a])},this):(this.trackMap={},this.trackLineMap={},c&&c.clear());r.forEach(d,function(b){this._repaint(b,
null,!0)},this.layer)},isLatestObservation:function(a){var d=this.trackMap[a.attributes[this.layer._trackIdField]];return d?d[d.length-1]===a:!1},destroy:function(){var a=this.container;a&&(a.clear(),a._unsetMap(this.map,this.layer._div));this.map=this.layer=this.trackMap=this.container=null}});p("extend-esri")&&n.setObject("layers._TrackManager",g,l);return g})},"esri/layers/SnapshotMode":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../SpatialReference ../tasks/query ./RenderMode".split(" "),
function(g,n,r,p,l,f,s){g=g([s],{declaredClass:"esri.layers._SnapshotMode",constructor:function(e){this.featureLayer=e;this.pagination=e.queryPagination;this._featureMap={};this._drawFeatures=n.hitch(this,this._drawFeatures);this._queryErrorHandler=n.hitch(this,this._queryErrorHandler)},startup:function(){this.pagination=this.pagination&&null!=this.featureLayer.maxRecordCount;this.featureLayer._collection?this._applyTimeFilter():this._fetchAll()},propertyChangeHandler:function(e){this._init&&(e?this.featureLayer._collection?
console.log("FeatureLayer: layer created by value (from a feature collection) does not support definition expressions and time definitions. Layer id \x3d "+this.featureLayer.id):this._fetchAll():this._applyTimeFilter())},drawFeature:function(e){var a=e.attributes[this.featureLayer.objectIdField];this._addFeatureIIf(a,e);this._incRefCount(a)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){var e=this.featureLayer;e._collection?(e._fireUpdateStart(),e._refresh(!0),e._fireUpdateEnd()):
this._fetchAll()},_getRequestId:function(e){return("_"+e.name+e.layerId+e._ulid).replace(/[^a-zA-Z0-9\_]+/g,"_")},_fetchAll:function(){var e=this.featureLayer;!e._collection&&!e.suspended&&(e._fireUpdateStart(),this._clearIIf(),this._sendRequest())},_sendRequest:function(e){var a=this.map,d=this.featureLayer,c=d.getDefinitionExpression(),b=new f;b.outFields=d.getOutFields();b.where=c||"1\x3d1";b.returnGeometry=!0;b.outSpatialReference=new l(a.spatialReference.toJson());b.timeExtent=d.getTimeDefinition();
b.maxAllowableOffset=d._maxOffset;d._ts&&(b._ts=(new Date).getTime());b.orderByFields=d.supportsAdvancedQueries?d.getOrderByFields():null;b.multipatchOption=d.multipatchOption;this.pagination&&(this._start=b.start=null==e?0:e,b.num=d.maxRecordCount);var k;d._usePatch&&(k=this._getRequestId(d),this._cancelPendingRequest(null,k));d._task.execute(b,this._drawFeatures,this._queryErrorHandler,k)},_drawFeatures:function(e){this._purgeRequests();var a=e.features,d=this.featureLayer,c=d.objectIdField,b,k=
a.length,m=e.exceededTransferLimit&&!d._collection,f,h;for(b=0;b<k;b++)f=a[b],h=f.attributes[c],this._addFeatureIIf(h,f),this._incRefCount(h);this._applyTimeFilter(!0);if(!this.pagination||!m)d._fireUpdateEnd(null,e.exceededTransferLimit?{queryLimitExceeded:!0}:null);m&&(this.pagination&&this._sendRequest(this._start+d.maxRecordCount),d.onQueryLimitExceeded())},_queryErrorHandler:function(e){this._purgeRequests();var a=this.featureLayer;a._errorHandler(e);a._fireUpdateEnd(e)}});r("extend-esri")&&
n.setObject("layers._SnapshotMode",g,p);return g})},"esri/layers/SelectionMode":function(){define(["dojo/_base/declare","dojo/_base/lang","dojo/has","../kernel","./RenderMode"],function(g,n,r,p,l){g=g([l],{declaredClass:"esri.layers._SelectionMode",constructor:function(f){this.featureLayer=f;this._featureMap={}},propertyChangeHandler:function(f){this._init&&0===f&&this._applyTimeFilter()},resume:function(){this.propertyChangeHandler(0)}});r("extend-esri")&&n.setObject("layers._SelectionMode",g,p);
return g})},"esri/layers/GridLayout":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../SpatialReference ../geometry/Extent ../geometry/Polyline".split(" "),function(g,n,r,p,l,f,s,e){g=g(null,{declaredClass:"esri.layers._GridLayout",constructor:function(a,d,c,b){this.origin=a;this.cellWidth=d.width;this.cellHeight=d.height;this.mapWidth=c.width;this.mapHeight=c.height;this.srInfo=b},setResolution:function(a){this._resolution=(a.xmax-a.xmin)/this.mapWidth;
this.srInfo&&(a=Math.round(2*this.srInfo.valid[1]/this._resolution),a=Math.round(a/this.cellWidth),this._frameStats=[a,0,a-1])},getCellCoordinates:function(a){var d=this._resolution,c=this.origin;return{row:Math.floor((c.y-a.y)/(this.cellHeight*d)),col:Math.floor((a.x-c.x)/(this.cellWidth*d))}},normalize:function(a){var d=this._frameStats;if(d){var c=d[0],b=d[1],d=d[2];a<b?(a%=c,a=a<b?a+c:a):a>d&&(a%=c)}return a},intersects:function(a,d){var c=this.srInfo;return c?r.some(d._getParts(c),function(b){return a.intersects(b.extent)}):
a.intersects(d)},getCellExtent:function(a,d){var c=this._resolution,b=this.origin,k=this.cellWidth,m=this.cellHeight;return new s(d*k*c+b.x,b.y-(a+1)*m*c,(d+1)*k*c+b.x,b.y-a*m*c,new f(b.spatialReference.toJson()))},getLatticeID:function(a){var d=this.getCellCoordinates({x:a.xmin,y:a.ymax}),c=this.getCellCoordinates({x:a.xmax,y:a.ymin});a=d.row;var b=c.row,d=this.normalize(d.col),c=this.normalize(c.col);return a+"_"+b+"_"+d+"_"+c},sorter:function(a,d){return a<d?-1:1},getCellsInExtent:function(a,d){var c=
this.getCellCoordinates({x:a.xmin,y:a.ymax}),b=this.getCellCoordinates({x:a.xmax,y:a.ymin}),k=c.row,m=b.row,c=c.col,b=b.col,f=[],h,q,l,g=[],n=[],s,r,p,w=[];for(h=k;h<=m;h++)for(q=c;q<=b;q++)l=this.normalize(q),a=this.getCellExtent(h,l),f.push({row:h,col:l,extent:a,resolution:this._resolution}),d&&(g.push(a.xmin,a.xmax),n.push(a.ymin,a.ymax));c=this.normalize(c);b=this.normalize(b);g.sort(this.sorter);n.sort(this.sorter);q=g.length;for(h=q-1;0<=h;h--)h<q-1&&g[h]===g[h+1]&&g.splice(h,1);q=n.length;
for(h=q-1;0<=h;h--)h<q-1&&n[h]===n[h+1]&&n.splice(h,1);if(g.length&&n.length){l=g[0];s=g[g.length-1];r=n[0];p=n[n.length-1];q=g.length;for(h=0;h<q;h++)w.push([[g[h],p],[g[h],r]]);q=n.length;for(h=0;h<q;h++)w.push([[l,n[h]],[s,n[h]]]);h=new e({paths:w,spatialReference:this.origin.spatialReference.toJson()});f.push({latticeID:k+"_"+m+"_"+c+"_"+b,lattice:h,resolution:this._resolution})}return{minRow:k,maxRow:m,minCol:c,maxCol:b,cells:f}}});p("extend-esri")&&n.setObject("layers._GridLayout",g,l);return g})},
"esri/layers/HeatmapManager":function(){define("dojo/_base/declare dojo/_base/lang dojo/on dojo/aspect dojo/_base/array require ../kernel ../sniff ../geometry/Point ./MapImageLayer ./MapImage ./FeatureLayer ../renderers/HeatmapRenderer ../tasks/query".split(" "),function(g,n,r,p,l,f,s,e,a,d,c,b,k,m){function E(){}g=g(null,{declaredClass:"esri.layers.HeatmapManager",heatmapRenderer:null,sourceLayer:null,imageLayer:null,useTiles:!0,useWorker:!1,map:null,constructor:function(b){var a=b.renderer;this.sourceLayer=
b;this.heatmapRenderer=a;this._hndls=[]},initialize:function(b){this.map=b;this.sourceLayer.setDrawMode(!1);var a=this,c=this.imageLayer=new d({className:"heatmapImgLyr"});!this.heatmapRenderer&&(this.sourceLayer&&this.sourceLayer.renderer)&&(this.heatmapRenderer=this.sourceLayer.renderer);this.recalculateHeatmap=this.recalculateHeatmap.bind(this);this._removeRenderer=this._removeRenderer.bind(this);this._handleRendererChange=this._handleRendererChange.bind(this);this._scRenderHandle=this.sourceLayer.on("renderer-change",
this._handleRendererChange);b.addLayer(c);f(["../workers/heatmapCalculator"],function(b){a._calculator=new b(n.mixin({width:a.map.width,height:a.map.height},a._getOptions()));a._setupRenderer()})},destroy:function(){this._removeHandlers();this._scRenderHandle.remove();this.map.removeLayer(this.imageLayer);this.sourceLayer.setRenderer(null);this.sourceLayer=this.imageLayer=this.map=this.heatmapRenderer=this._hndls=this._scRenderHandle=null},_handleRendererChange:function(b){var a=b.renderer,c=a instanceof
k;this.heatmapRenderer?c?this.heatmapRenderer=a:this._removeRenderer(b):c&&(this.heatmapRenderer=a,this._setupRenderer())},_setupRenderer:function(){var a=this._hndls,c=this.sourceLayer,d=this.map;c._originalDraw=c._draw;c._draw=E;var k=this;a.push(c.on("update-end",function(b){k.recalculateHeatmap()}));a.push(c.on("suspend",function(b){k.imageLayer.suspend()}));a.push(c.on("resume",function(b){k.imageLayer.resume()}));a.push(p.after(c,"redraw",this.recalculateHeatmap));a.push(d.on("layer-remove",
function(b){b.layer==k.sourceLayer&&d.removeLayer(k.imageLayer)}));c.mode!==b.MODE_ONDEMAND&&a.push(d.on("resize, zoom-end, pan-end",function(b){setTimeout(k.recalculateHeatmap,16)}));c.graphics&&c.graphics.length&&this.recalculateHeatmap()},_removeRenderer:function(b){b=b.target;b._draw=b._originalDraw;delete b._originalDraw;b.setDrawMode(!0);this.heatmapRenderer=null;this._removeHandlers();this._hndls=[]},recalculateHeatmap:function(){this._calculator?this._doMainCalculation():this._calculatorClient&&
this._doWorkerCalculation()},_doWorkerCalculation:function(){},_doMainCalculation:function(){var b=this.sourceLayer,d=this.imageLayer,k=this.map,e=this.heatmapRenderer,f=this.map.extent,g=this.map.width,s=this.map.height,E=this._calculator,r=this,p=function(m){m=m.features;var p=[],u=m.length,x=0,v,C=k.toScreen(new a(0,0)),I=C.x,C=C.y,J=k.getResolution(),A=0;k.extent._parts&&(A=l.map(k.extent._parts,function(a){return Math.abs(b._intersects(k,a.extent)[0])}),A.sort(function(b,a){return a-b}),A=A[0]);
for(;u--;)v=m[u],v.geometry&&(v={x:Math.abs(Math.ceil(v.geometry.x/J+I)),y:Math.abs(Math.floor(v.geometry.y/J-C)),attributes:v.attributes},v.x>k.width&&(v.x-=A),0>v.x&&(v.x+=A),p[x++]=v);m=E.calculateImageData(n.mixin({screenPoints:p,mapinfo:{extent:[f.xmin,f.ymin,f.xmax,f.ymax],resolution:k.getResolution()},width:g,height:s},r._getOptions()));m=e.getSymbol({geometry:k.extent,attributes:{size:[g,s],imageData:m}});m=new c({extent:k.extent,href:m.url});d.addImage(m);setTimeout(function(){var b=d._mapImages.slice(0,
-1),a=b.length;if(1E3<a)b=d._mapImages[a],d.removeAllImages(),d.addImage(b);else for(;a--&&b[a];)d.removeImage(b[a])},250)},x={geometry:k.extent,timeExtent:k.timeExtent,spatialRelationship:m.SPATIAL_REL_INTERSECTS};null!=b._canDoClientSideQuery(x)?b.queryFeatures(x,p):p({features:b.graphics})},_removeHandlers:function(){for(var b=this._hndls.length;b--;)this._hndls[b].remove()},_getOptions:function(){var b=this.heatmapRenderer;return{blurRadius:b.blurRadius,gradient:b.gradient,maxPixelIntensity:b.maxPixelIntensity,
minPixelIntensity:b.minPixelIntensity,field:b.field}}});e("extend-esri")&&n.setObject("layers.HeatmapManager",g,s);return g})},"esri/renderers/HeatmapRenderer":function(){define("dojo/_base/declare dojo/_base/lang dojo/dom-construct ../sniff ../kernel ../lang ../symbols/PictureMarkerSymbol ./Renderer".split(" "),function(g,n,r,p,l,f,s,e){g=g([e],{declaredClass:"esri.renderer.HeatmapRenderer",colors:null,blurRadius:10,maxPixelIntensity:100,minPixelIntensity:0,field:null,constructor:function(a){this._supportsCanvas=
window.CanvasRenderingContext2D?!0:!1;this._supportTypedArray=window.ArrayBuffer?!0:!1;this._supportsCanvas?this._supportTypedArray?("string"==typeof a&&(a=JSON.parse(a)),n.mixin(this,a),this._canvas=null,this.colors||(this.colors=["rgba(255, 140, 0, 0)","rgba(255, 140, 0, 1)","rgba(255, 0,   0, 1)"]),this.gradient=this._generateGradient(this.colors)):console.log("The HeatmapRenderer requires a browser that supports TypedArrays. IE9 and less do not support TypedArrays."):console.log("The HeatmapRenderer requires a Canvas enabled Browser.  IE8 and less does not support Canvas.")},
getSymbol:function(a){if(!this._supportsCanvas||!this._supportTypedArray)return!1;var d=a.attributes.imageData;a=a.attributes.size;if(!a)return null;var c=this._getContext(a[0],a[1]),b=c.getImageData(0,0,a[0],a[1]);d instanceof ArrayBuffer?d=window.Uint8ClampedArray?new Uint8ClampedArray(d):new Uint8Array(d):d.BYTES_PER_ELEMENT&&1!==d.BYTES_PER_ELEMENT&&(d=window.Uint8ClampedArray?new Uint8ClampedArray(d.buffer):new Uint8Array(d.buffer));if(window.CanvasPixelArray&&b.data instanceof window.CanvasPixelArray)for(var k=
b.data,m=k.length;m--;)k[m]=d[m];else b.data.set(d);c.putImageData(b,0,0);return new s(c.canvas.toDataURL(),a[0],a[1])},setColors:function(a){if(a&&(a instanceof Array||a.colors))this.gradient=this._generateGradient(a.colors||a)},setMaxPixelIntensity:function(a){this.maxPixelIntensity=a},setMinPixelIntensity:function(a){this.minPixelIntensity=a},setField:function(a){this.field=a},setBlurRadius:function(a){this.blurRadius=a},toJson:function(){var a=n.mixin(this.inherited(arguments),{type:"heatmap",
blurRadius:this.blurRadius,colors:this.colors instanceof Uint32Array?null:this.colors,maxPixelIntensity:this.maxPixelIntensity,minPixelIntensity:this.minPixelIntensity,field:this.field});return f.fixJson(a)},_getContext:function(a,d){this._canvas?(this._canvas.width=a,this._canvas.height=d):this._canvas=this._initCanvas(a,d);return this._canvas.getContext("2d")},_initCanvas:function(a,d){var c=r.create("canvas",{id:"hm_canvas-"+Math.floor(1E3*Math.random()),style:"position: absolute; left: -10000px; top: 0px;"},
null);c.width=a;c.height=d;document.body.appendChild(c);return c},_generateGradient:function(a,d){d||(d=512);var c=this._getContext(1,d||512),b=c.createLinearGradient(0,0,0,d),k,m=a.length-1;for(k=0;k<=m;k++)b.addColorStop(k/m,a[k]);c.fillStyle=b;c.fillRect(0,0,1,d);c=c.getImageData(0,0,1,d).data;return c.buffer?new Uint32Array(c.buffer):new Uint32Array((new Uint8Array(c)).buffer)}});p("extend-esri")&&n.setObject("renderer.HeatmapRenderer",g,l);return g})},"esri/layers/FeatureType":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../lang ../symbols/jsonUtils ./RangeDomain ./CodedValueDomain ./InheritedDomain ./FeatureTemplate".split(" "),
function(g,n,r,p,l,f,s,e,a,d,c){g=g(null,{declaredClass:"esri.layers.FeatureType",constructor:function(b){if(b&&n.isObject(b)){this.id=b.id;this.name=b.name;var k=b.symbol;k&&(this.symbol=s.fromJson(k));var k=b.domains,m,f=this.domains={};for(m in k)if(k.hasOwnProperty(m)){var h=k[m];switch(h.type){case "range":f[m]=new e(h);break;case "codedValue":f[m]=new a(h);break;case "inherited":f[m]=new d(h)}}if(m=b.templates){k=this.templates=[];for(b=0;b<m.length;b++)k.push(new c(m[b]))}}},toJson:function(){var b=
{id:this.id,name:this.name,symbol:this.symbol&&this.symbol.toJson()},a,c=this.domains,d=this.templates,h=f.fixJson;if(c){var e=b.domains={};for(a in c)c.hasOwnProperty(a)&&(e[a]=c[a]&&c[a].toJson());h(e)}d&&(b.templates=r.map(d,function(b){return b.toJson()}));return h(b)}});p("extend-esri")&&n.setObject("layers.FeatureType",g,l);return g})},"esri/layers/RenderMode":function(){define("dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has dojo/io/script ../kernel".split(" "),
function(g,n,r,p,l,f,s){n=n(null,{declaredClass:"esri.layers._RenderMode",constructor:function(){this._prefix="jsonp_"+(g._scopeName||"dojo")+"IoScript"},initialize:function(e){this.map=e;this._init=!0},startup:function(){},propertyChangeHandler:function(e){},destroy:function(){this._init=!1},drawFeature:function(e){},suspend:function(){},resume:function(){},refresh:function(){},_incRefCount:function(e){(e=this._featureMap[e])&&e._count++},_decRefCount:function(e){(e=this._featureMap[e])&&e._count--},
_getFeature:function(e){return this._featureMap[e]},_addFeatureIIf:function(e,a){var d=this._featureMap,c=d[e],b=this.featureLayer;c||(d[e]=a,b._add(a),a._count=0);return c||a},_removeFeatureIIf:function(e){var a=this._featureMap[e],d=this.featureLayer;if(a){if(a._count)return;delete this._featureMap[e];d._remove(a)}return a},_clearIIf:function(){var e;e=this.featureLayer;var a=e.graphics,d=e._selectedFeatures,c=e.objectIdField;for(e=a.length-1;0<=e;e--){var b=a[e],k=b.attributes[c];k in d?b._count=
1:(b._count=0,this._removeFeatureIIf(k))}},_isPending:function(e){return f[this._prefix+e]?!0:!1},_cancelPendingRequest:function(e,a){if(e=e||f[this._prefix+a])try{e.cancel(),f._validCheck(e)}catch(d){}},_purgeRequests:function(){f._validCheck(null)},_toggleVisibility:function(e){var a=this.featureLayer,d=a.graphics,c=e?"show":"hide",b,k=d.length;e=e&&a._ager;for(b=0;b<k;b++){var m=d[b];m[c]();e&&a._repaint(m)}},_applyTimeFilter:function(e){var a=this.featureLayer;if(a.timeInfo&&!a.suspended){e||
a._fireUpdateStart();var d=a._trackManager;d&&d.clearTracks();var c=a.getTimeDefinition(),b=a._getOffsettedTE(a._mapTimeExtent);b?(b=a._getTimeOverlap(c,b))?(c=a._filterByTime(a.graphics,b.startTime,b.endTime),d&&d.addFeatures(c.match),p.forEach(c.match,function(b){var c=b._shape;b.visible||(b.show(),(c=b._shape)&&c._moveToFront());a._ager&&c&&a._repaint(b)}),p.forEach(c.noMatch,function(b){b.visible&&b.hide()})):this._toggleVisibility(!1):(d&&d.addFeatures(a.graphics),this._toggleVisibility(!0));
d&&(d.moveLatestToFront(),d.drawTracks());e||a._fireUpdateEnd()}}});l("extend-esri")&&r.setObject("layers._RenderMode",n,s);return n})},"esri/layers/StreamMode":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../SpatialReference ../tasks/query ../tasks/QueryTask ../geometry/jsonUtils ./RenderMode".split(" "),function(g,n,r,p,l,f,s,e,a,d){g=g([d],{declaredClass:"esri.layers._StreamMode",constructor:function(a,b){this.featureLayer=a;this._featureMap={};this._setRefreshRate();
this._drawBuffer={adds:[],updates:[]};this._timeoutId=null;this._flushDrawBuffer=n.hitch(this,this._flushDrawBuffer);this._drawFeatures=n.hitch(this,this._drawFeatures);this._queryErrorHandler=n.hitch(this,this._queryErrorHandler)},startup:function(){},propertyChangeHandler:function(a){this._init&&(0===a?this._applyTimeFilter():3===a?this._redrawAllTracks():console.debug("StreamLayer: Stream Layer only supports changing map time or maximumTrackPoints. Layer id \x3d "+this.featureLayer.id))},drawFeature:function(a){var b=
this.featureLayer,d=b.objectIdField;this._timeoutId||(this._timeoutId=setTimeout(this._flushDrawBuffer,this._refreshRate));b._joinField&&this._getFeature(a.attributes[d])?this._drawBuffer.updates.push({oid:a.attributes[d],updates:a}):this._drawBuffer.adds.push(a)},resume:function(){this.propertyChangeHandler(0)},refresh:function(){var a=this.featureLayer;a._collection?(a._fireUpdateStart(),a._refresh(!0),a._fireUpdateEnd()):this._fetchArchive()},_drawFeatures:function(a){this._purgeRequests();var b=
this.featureLayer;b._create(a.features||[]);b._fireUpdateEnd(null,null)},_applyTimeFilter:function(a){this.inherited(arguments);this._redrawAllTracks()},_removeFeatures:function(a){var b=this.featureLayer,d=b.objectIdField;a&&r.forEach(a,function(a){a=a.attributes[d];b._unSelectFeatureIIf(a,this);this._decRefCount(a);this._removeFeatureIIf(a)},this)},_addFeatures:function(a){var b=this.featureLayer,d,m,e,h=[],f=[],l=[];d=b._trackManager;m=b.objectIdField;if(d)for(e in a=d.addFeatures(a),a)a.hasOwnProperty(e)&&
(h.push(e),a[e].adds&&(f=f.concat(a[e].adds)),a[e].deletes&&(l=l.concat(a[e].deletes)));else f=a;r.forEach(f,function(b){var a=b.attributes[m];this._addFeatureIIf(a,b);this._incRefCount(a)},this);l.length&&this._removeFeatures(l);d&&d.refreshTracks(h)},_updateFeatures:function(a){var b=this.featureLayer,d,e,f=[];d=b._trackManager;e=b._trackIdField;r.forEach(a,function(a){var c=a.updates;a=this._getFeature(a.oid);var l;if(a){c.geometry&&(a.geometry=c.geometry);c=c.attributes||{};for(l in c)c.hasOwnProperty(l)&&
(a.attributes[l]=c[l]);a.visible=this._checkFeatureTimeIntersects(a);d&&a.attributes[e]?f.push(a.attributes[e]):b._repaint(a,null,!0)}},this);f.length&&d.refreshTracks(f)},_redrawAllTracks:function(){var a=this.featureLayer._trackManager,b;if(a&&(b=a.trimTracks())&&0<b.length)this._removeFeatures(b),a.refreshTracks()},_flushDrawBuffer:function(){clearTimeout(this._timeoutId);var a=this._drawBuffer,b=a.adds.splice(0,a.adds.length),a=a.updates.splice(0,a.updates.length),d=this.featureLayer;if(!d)return!1;
d.onUpdateStart();this._addFeatures(b);this._updateFeatures(a);d._purge();d.onUpdateEnd();this._timeoutId=null},_clearDrawBuffer:function(){var a=this._timeoutId,b=this._drawBuffer,d=b.adds,b=b.updates;a&&clearTimeout(a);d.splice(0,d.length);b.splice(0,b.length);this._timeoutId=null},_setRefreshRate:function(a){a=a||0===a?a:200;0>a&&(a=200);this._refreshRate=a},_checkFeatureTimeIntersects:function(a){var b=this.featureLayer,d=b.getMap().timeExtent;return!d||!b.timeInfo||!b.timeInfo.startTimeField&&
!b.timeInfo.endTimeField?!0:0<b._filterByTime([a],d.startTime,d.endTime).match.length},_getRequestId:function(a){return("_"+a.name+a.layerId+a._ulid).replace(/[^a-zA-Z0-9\_]+/g,"_")},_fetchArchive:function(c){var b=this.featureLayer,d,m,l,h,g,n;b._fireUpdateStart();if(c)c=new e(c),d=new s,m=this.map,l=b.getFilter()||{},h=l.where||"1\x3d1",g=l.geometry?a.fromJson(l.geometry):null,l=l.outFields?l.outFields.split(","):["*"],d.geometry=g,d.where=h,d.outFields=l,d.returnGeometry=!0,d.outSpatialReference=
new f(m.spatialReference.toJson()),b._usePatch&&(n=this._getRequestId(b),this._cancelPendingRequest(null,n)),c.execute(d,this._drawFeatures,this._queryErrorHandler,n);else return this._fireUpdateEnd({error:"No url provided"}),!1},_queryErrorHandler:function(a){this._purgeRequests();var b=this.featureLayer;b._errorHandler(a);b._fireUpdateEnd(a)}});p("extend-esri")&&n.setObject("layers._StreamMode",g,l);return g})},"esri/tasks/StatisticDefinition":function(){define(["dojo/_base/declare","dojo/_base/lang",
"dojo/has","../kernel"],function(g,n,r,p){g=g(null,{declaredClass:"esri.tasks.StatisticDefinition",toJson:function(){return{statisticType:this.statisticType,onStatisticField:this.onStatisticField,outStatisticFieldName:this.outStatisticFieldName,maxPointCount:this.maxPointCount,maxRecordCount:this.maxRecordCount,maxVertexCount:this.maxVertexCount}}});r("extend-esri")&&n.setObject("tasks.StatisticDefinition",g,p);return g})},"esri/tasks/Task":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/json dojo/has ../kernel ../deferredUtils ../urlUtils ../Evented".split(" "),
function(g,n,r,p,l,f,s,e){g=g(e,{declaredClass:"esri.tasks._Task",_eventMap:{error:["error"],complete:["result"]},constructor:function(a,d){a&&n.isString(a)&&(this._url=s.urlToObject(this.url=a));d&&d.requestOptions&&(this.requestOptions=d.requestOptions);this.normalization=!0;this._errorHandler=n.hitch(this,this._errorHandler);this.registerConnectEvents()},_useSSL:function(){var a=this._url,d=/^http:/i;this.url&&(this.url=this.url.replace(d,"https:"));a&&a.path&&(a.path=a.path.replace(d,"https:"))},
_encode:function(a,d,c){var b,e,m={},f,h;for(f in a)if("declaredClass"!==f&&(b=a[f],e=typeof b,null!==b&&void 0!==b&&"function"!==e))if(n.isArray(b)){m[f]=[];h=b.length;for(e=0;e<h;e++)m[f][e]=this._encode(b[e])}else"object"===e?b.toJson&&(e=b.toJson(c&&c[f]),"esri.tasks.FeatureSet"===b.declaredClass&&e.spatialReference&&(e.sr=e.spatialReference,delete e.spatialReference),m[f]=d?e:r.toJson(e)):m[f]=b;return m},_successHandler:function(a,d,c,b){d&&this[d].apply(this,a);c&&c.apply(null,a);b&&f._resDfd(b,
a)},_errorHandler:function(a,d,c){this.onError(a);d&&d(a);c&&c.errback(a)},setNormalization:function(a){this.normalization=a},onError:function(){}});p("extend-esri")&&(l.Task=g);return g})},"esri/tasks/QueryTask":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/_base/json dojo/has ../kernel ../request ../deferredUtils ../geometry/Extent ../geometry/normalizeUtils ./Task ./FeatureSet".split(" "),function(g,n,r,p,l,f,s,e,a,d,c,b,k){g=g(b,{declaredClass:"esri.tasks.QueryTask",
_eventMap:{complete:["featureSet"],"execute-for-count-complete":["count"],"execute-for-ids-complete":["objectIds"],"execute-relationship-query-complete":["featureSets"]},constructor:function(a,b){this._handler=n.hitch(this,this._handler);this._relationshipQueryHandler=n.hitch(this,this._relationshipQueryHandler);this._executeForIdsHandler=n.hitch(this,this._executeForIdsHandler);this._countHandler=n.hitch(this,this._countHandler);this._extentHandler=n.hitch(this,this._extentHandler);this.source=b&&
b.source;this.gdbVersion=b&&b.gdbVersion;this.registerConnectEvents()},__msigns:[{n:"execute",c:4,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForIds",c:3,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForCount",c:3,a:[{i:0,p:["geometry"]}],e:2},{n:"executeForExtent",c:3,a:[{i:0,p:["geometry"]}],e:2}],onComplete:function(){},onExecuteRelationshipQueryComplete:function(){},onExecuteForIdsComplete:function(){},onExecuteForCountComplete:function(){},onExecuteForExtentComplete:function(){},execute:function(a,b,
c,d,f){var k=f.assembly;a=this._encode(n.mixin({},this._url.query,{f:"json"},a.toJson(k&&k[0])));var g=this._handler,s=this._errorHandler;this.source&&(k={source:this.source.toJson()},a.layer=l.toJson(k));this.gdbVersion&&(a.gdbVersion=this.gdbVersion);return e({url:this._url.path+"/query",content:a,callbackParamName:"callback",load:function(a,d){g(a,d,b,c,f.dfd)},error:function(a){s(a,c,f.dfd)},callbackSuffix:d},this.requestOptions)},executeRelationshipQuery:function(b,c,d){b=this._encode(n.mixin({},
this._url.query,{f:"json"},b.toJson()));var f=this._relationshipQueryHandler,l=this._errorHandler;this.gdbVersion&&(b.gdbVersion=this.gdbVersion);var k=new p(a._dfdCanceller);k._pendingDfd=e({url:this._url.path+"/queryRelatedRecords",content:b,callbackParamName:"callback",load:function(a,b){f(a,b,c,d,k)},error:function(a){l(a,d,k)}},this.requestOptions);return k},executeForIds:function(a,b,c,d){var f=d.assembly;a=this._encode(n.mixin({},this._url.query,{f:"json",returnIdsOnly:!0},a.toJson(f&&f[0])));
var k=this._executeForIdsHandler,g=this._errorHandler;this.source&&(f={source:this.source.toJson()},a.layer=l.toJson(f));this.gdbVersion&&(a.gdbVersion=this.gdbVersion);return e({url:this._url.path+"/query",content:a,callbackParamName:"callback",load:function(a,e){k(a,e,b,c,d.dfd)},error:function(a){g(a,c,d.dfd)}},this.requestOptions)},executeForCount:function(a,b,c,d){var f=d.assembly;a=this._encode(n.mixin({},this._url.query,{f:"json",returnIdsOnly:!0,returnCountOnly:!0},a.toJson(f&&f[0])));var k=
this._countHandler,g=this._errorHandler;this.source&&(f={source:this.source.toJson()},a.layer=l.toJson(f));this.gdbVersion&&(a.gdbVersion=this.gdbVersion);return e({url:this._url.path+"/query",content:a,callbackParamName:"callback",load:function(a,e){k(a,e,b,c,d.dfd)},error:function(a){g(a,c,d.dfd)}},this.requestOptions)},executeForExtent:function(a,b,c,d){var f=d.assembly;a=this._encode(n.mixin({},this._url.query,{f:"json",returnExtentOnly:!0,returnCountOnly:!0},a.toJson(f&&f[0])));var k=this._extentHandler,
g=this._errorHandler;this.source&&(f={source:this.source.toJson()},a.layer=l.toJson(f));this.gdbVersion&&(a.gdbVersion=this.gdbVersion);return e({url:this._url.path+"/query",content:a,callbackParamName:"callback",load:function(a,e){k(a,e,b,c,d.dfd)},error:function(a){g(a,c,d.dfd)}},this.requestOptions)},_handler:function(a,b,c,d,e){try{var f=new k(a);this._successHandler([f],"onComplete",c,e)}catch(l){this._errorHandler(l,d,e)}},_relationshipQueryHandler:function(a,b,c,d,e){try{var f=a.geometryType,
l=a.spatialReference,g={};r.forEach(a.relatedRecordGroups,function(a){var b={};b.geometryType=f;b.spatialReference=l;b.features=a.relatedRecords;b=new k(b);if(null!=a.objectId)g[a.objectId]=b;else for(var c in a)a.hasOwnProperty(c)&&"relatedRecords"!==c&&(g[a[c]]=b)});this._successHandler([g],"onExecuteRelationshipQueryComplete",c,e)}catch(n){this._errorHandler(n,d,e)}},_executeForIdsHandler:function(a,b,c,d,e){try{this._successHandler([a.objectIds],"onExecuteForIdsComplete",c,e)}catch(f){this._errorHandler(f,
d,e)}},_countHandler:function(a,b,c,d,e){try{var f,l=a.features,k=a.objectIds;if(k)f=k.length;else{if(l)throw Error("Unable to perform query. Please check your parameters.");f=a.count}this._successHandler([f],"onExecuteForCountComplete",c,e)}catch(g){this._errorHandler(g,d,e)}},_extentHandler:function(a,b,c,e,f){try{a.extent&&(a.extent=new d(a.extent)),this._successHandler([a],"onExecuteForExtentComplete",c,f)}catch(l){this._errorHandler(l,e,f)}}});c._createWrappers(g);f("extend-esri")&&n.setObject("tasks.QueryTask",
g,s);return g})},"esri/tasks/FeatureSet":function(){define("dojo/_base/declare dojo/_base/lang dojo/_base/array dojo/has ../kernel ../lang ../graphic ../SpatialReference ../graphicsUtils ../geometry/jsonUtils ../symbols/jsonUtils".split(" "),function(g,n,r,p,l,f,s,e,a,d,c){g=g(null,{declaredClass:"esri.tasks.FeatureSet",constructor:function(a){if(a){n.mixin(this,a);var f=this.features,l=a.spatialReference,g=d.getGeometryType(a.geometryType),l=this.spatialReference=new e(l);this.geometryType=a.geometryType;
a.fields&&(this.fields=a.fields);r.forEach(f,function(a,b){var d=a.geometry&&a.geometry.spatialReference;f[b]=new s(g&&a.geometry?new g(a.geometry):null,a.symbol&&c.fromJson(a.symbol),a.attributes);f[b].geometry&&!d&&f[b].geometry.setSpatialReference(l)})}else this.features=[]},displayFieldName:null,geometryType:null,spatialReference:null,fieldAliases:null,toJson:function(b){var c={};this.displayFieldName&&(c.displayFieldName=this.displayFieldName);this.fields&&(c.fields=this.fields);this.spatialReference?
c.spatialReference=this.spatialReference.toJson():this.features[0]&&this.features[0].geometry&&(c.spatialReference=this.features[0].geometry.spatialReference.toJson());this.features[0]&&(this.features[0].geometry&&(c.geometryType=d.getJsonType(this.features[0].geometry)),c.features=a._encodeGraphics(this.features,b));c.exceededTransferLimit=this.exceededTransferLimit;return f.fixJson(c)}});p("extend-esri")&&n.setObject("tasks.FeatureSet",g,l);return g})},"esri/layers/FeatureTemplate":function(){define("dojo/_base/declare dojo/_base/lang dojo/has ../kernel ../lang ../graphic".split(" "),
function(g,n,r,p,l,f){g=g(null,{declaredClass:"esri.layers.FeatureTemplate",constructor:function(l){l&&n.isObject(l)&&(this.name=l.name,this.description=l.description,this.drawingTool=l.drawingTool,l=l.prototype,this.prototype=new f(l.geometry,null,l.attributes))},toJson:function(){return l.fixJson({name:this.name,description:this.description,drawingTool:this.drawingTool,prototype:this.prototype&&this.prototype.toJson()})}});n.mixin(g,{TOOL_AUTO_COMPLETE_POLYGON:"esriFeatureEditToolAutoCompletePolygon",
TOOL_CIRCLE:"esriFeatureEditToolCircle",TOOL_ELLIPSE:"esriFeatureEditToolEllipse",TOOL_FREEHAND:"esriFeatureEditToolFreehand",TOOL_LINE:"esriFeatureEditToolLine",TOOL_NONE:"esriFeatureEditToolNone",TOOL_POINT:"esriFeatureEditToolPoint",TOOL_POLYGON:"esriFeatureEditToolPolygon",TOOL_RECTANGLE:"esriFeatureEditToolRectangle",TOOL_ARROW:"esriFeatureEditToolArrow",TOOL_TRIANGLE:"esriFeatureEditToolTriangle",TOOL_LEFT_ARROW:"esriFeatureEditToolLeftArrow",TOOL_RIGHT_ARROW:"esriFeatureEditToolRightArrow",
TOOL_UP_ARROW:"esriFeatureEditToolUpArrow",TOOL_DOWN_ARROW:"esriFeatureEditToolDownArrow"});r("extend-esri")&&n.setObject("layers.FeatureTemplate",g,p);return g})},"*noref":1}});
define("esri/layers/FeatureLayer","require module dojo/_base/declare dojo/_base/connect dojo/_base/lang dojo/_base/array dojo/_base/json dojo/_base/Deferred dojo/date/locale dojo/sniff dojo/io-query dojo/dom-construct dojo/i18n dojo/when dojo/promise/all ../kernel ../lang ../request ../config ../deferredUtils ../SpatialReference ../symbols/SimpleMarkerSymbol ../symbols/SimpleLineSymbol ../symbols/SimpleFillSymbol ../symbols/jsonUtils ../renderers/SimpleRenderer ../renderers/UniqueValueRenderer ../renderers/jsonUtils ../tasks/QueryTask ../tasks/query ../tasks/FeatureSet ../tasks/StatisticDefinition ../geometry/Extent ../geometry/jsonUtils ../geometry/normalizeUtils ../geometry/scaleUtils ./GraphicsLayer ./Field ./TimeInfo ./FeatureType ./FeatureTemplate ./FeatureEditResult ./LabelClass ./SnapshotMode ./OnDemandMode ./SelectionMode ./StreamMode ./TrackManager ./HeatmapManager dojo/i18n!../nls/jsapi dojo/has!extend-esri?./agscommon".split(" "),function(g,
n,r,p,l,f,s,e,a,d,c,b,k,m,E,h,q,F,P,B,K,Q,R,w,u,x,S,T,U,L,v,C,I,J,A,V,W,X,Y,Z,$,G,aa,M,ba,ca,da,ea,fa,ga){var ha=P.defaults,z=r(W,{declaredClass:"esri.layers.FeatureLayer",invalidParams:"query contains one or more unsupported parameters",reHostedFS:/https?:\/\/services.*\.arcgis\.com/i,maxPointCountForAuto:4E3,maxRecordCountForAuto:2E3,maxVertexCountForAuto:25E4,generalizeForScale:4E3,_eventMap:{"add-attachment-complete":["result"],"before-apply-edits":["adds","updates","deletes"],"delete-attachments-complete":["results"],
"edits-complete":["adds","updates","deletes"],"query-attachment-infos-complete":["results"],"query-count-complete":["count"],"query-features-complete":["featureSet"],"query-ids-complete":["objectIds"],"query-related-features-complete":["featureSets"],"selection-complete":["features","method"],"update-end":["error","info"]},constructor:function(a,b){this._preventInit||this._initFeatureLayer(a,b)},_initFeatureLayer:function(a,b){this.i18n=ga;b=b||{};this.showLabels=null!=b.showLabels?b.showLabels:!0;
this._outFields=b.outFields;this._defnExpr=b.definitionExpression;this._loadCallback=b.loadCallback;var c=b._usePatch;this._usePatch=null===c||void 0===c?!0:c;this._trackIdField=b.trackIdField;this.objectIdField=b.objectIdField;this._maxOffset=null!=b.maxAllowableOffset?b.maxAllowableOffset:this.maxAllowableOffset;this._optEditable=b.editable;this._optAutoGen=b.autoGeneralize;this.editSummaryCallback=b.editSummaryCallback;this.userId=b.userId;this.userIsAdmin=b.userIsAdmin;this.useMapTime=b.hasOwnProperty("useMapTime")?
!!b.useMapTime:!0;this.source=b.source;this.gdbVersion=b.gdbVersion;this.orderByFields=b.orderByFields;this.maxPointCountForAuto=null!=b.maxPointCountForAuto?b.maxPointCountForAuto:this.maxPointCountForAuto;this.maxRecordCountForAuto=null!=b.maxRecordCountForAuto?b.maxRecordCountForAuto:this.maxRecordCountForAuto;this.maxVertexCountForAuto=null!=b.maxVertexCountForAuto?b.maxVertexCountForAuto:this.maxVertexCountForAuto;this.generalizeForScale=null!=b.generalizeForScale?b.generalizeForScale:this.generalizeForScale;
this.queryPagination=null!=b.queryPagination?b.queryPagination:this.url?this.reHostedFS.test(this.url):!1;this.multipatchOption=b.multipatchOption;this._selectedFeatures={};this._selectedFeaturesArr=[];this._newFeatures=[];this._deletedFeatures={};this._ulid=this._getUniqueId();var d=z,c=this.mode=q.isDefined(b.mode)?b.mode:d.MODE_ONDEMAND;this._isStream&&(this.mode=c=d.MODE_STREAM);switch(c){case d.MODE_SNAPSHOT:this.currentMode=d.MODE_SNAPSHOT;this._mode=new M(this);this._isSnapshot=!0;break;case d.MODE_ONDEMAND:case d.MODE_AUTO:this.currentMode=
d.MODE_ONDEMAND;this._tileWidth=b.tileWidth||512;this._tileHeight=b.tileHeight||512;this._mode=new ba(this);this.latticeTiling=b.latticeTiling;break;case d.MODE_SELECTION:this.currentMode=d.MODE_SELECTION;this._mode=new ca(this);this._isSelOnly=!0;break;case d.MODE_STREAM:this.currentMode=d.MODE_STREAM,this._mode=new da(this),this._isStream=!0}this._initLayer=l.hitch(this,this._initLayer);this._selectHandler=l.hitch(this,this._selectHandler);this._editable=!1;if(l.isObject(a)&&a.layerDefinition)return this._collection=
!0,this.mode=this._isStream?d.MODE_STREAM:d.MODE_SNAPSHOT,this._initLayer(a),this;this._task=new U(this.url,{source:this.source,gdbVersion:this.gdbVersion});c=this._url.path;this._fserver=!1;-1!==c.search(/\/FeatureServer\//i)&&(this._fserver=!0);this.mode===d.MODE_AUTO&&this.reHostedFS.test(this.url)&&this._queryLimit();(d=b.resourceInfo)?this._initLayer(d):(this.source&&(d={source:this.source.toJson()},this._url.query=l.mixin(this._url.query,{layer:s.toJson(d)})),this.gdbVersion&&(this._url.query=
l.mixin(this._url.query,{gdbVersion:this.gdbVersion})),F({url:c,content:l.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler}));this.registerConnectEvents()},_initLayer:function(a,b){if(a||b){this._json=a;this._findCredential();if(this.credential&&this.credential.ssl||a&&a._ssl)this._useSSL(),this._task._useSSL();this._collection&&(this._isStream||(this.currentMode=z.MODE_SNAPSHOT,this._mode=new M(this)),this._isSnapshot=!0,this._featureSet=
a.featureSet,this._nextId=a.nextObjectId,a=a.layerDefinition);this.geometryType=a.geometryType;"string"!==typeof this.multipatchOption&&"esriGeometryMultiPatch"===this.geometryType&&(this.multipatchOption="xyFootprint");if(a.hasOwnProperty("capabilities")){var c=this.capabilities=a.capabilities;c&&-1!==c.toLowerCase().indexOf("editing")?this._editable=!0:this._editable=!1}else this._collection||(this._editable=this._fserver);q.isDefined(this._optEditable)?(this._editable=this._optEditable,delete this._optEditable):
"esriGeometryMultiPatch"===this.geometryType&&(this._editable=!1);this._json=s.toJson(this._json);if(this.isEditable())delete this._maxOffset;else if(this.currentMode!==z.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||this.hasXYFootprint()))this._autoGeneralize=q.isDefined(this._optAutoGen)?this._optAutoGen:this.currentMode===z.MODE_ONDEMAND,delete this._optAutoGen;var c=a.effectiveMinScale||a.minScale,t=a.effectiveMaxScale||a.maxScale;!this._hasMin&&
c&&this.setMinScale(c);!this._hasMax&&t&&this.setMaxScale(t);this.layerId=a.id;this.name=a.name;this.description=a.description;this.copyright=a.copyrightText;this.type=a.type;this.displayField=a.displayField;this.defaultDefinitionExpression=a.definitionExpression;this.fullExtent=new I(a.extent);this.initialExtent=new I(this.fullExtent.toJson());this.fullExtent.spatialReference&&(this.spatialReference=new K(this.fullExtent.spatialReference.toJson()));this.defaultVisibility=a.defaultVisibility;if("esriGeometryPoint"===
this.geometryType||"esriGeometryMultipoint"===this.geometryType)this.latticeTiling=!1;this.indexedFields=a.indexedFields;this.maxRecordCount=a.maxRecordCount;this.canModifyLayer=a.canModifyLayer;this.supportsStatistics=a.supportsStatistics;this.supportsAdvancedQueries=this._collection?!1:a.supportsAdvancedQueries;this.supportsCalculate=a.supportsCalculate;this.supportsAttachmentsByUploadId=a.supportsAttachmentsByUploadId;this.hasLabels=a.hasLabels;this.canScaleSymbols=a.canScaleSymbols;this.supportsRollbackOnFailureParameter=
this.supportsRollbackOnFailure=a.supportsRollbackOnFailure;this.syncCanReturnChanges=a.syncCanReturnChanges;this.isDataVersioned=a.isDataVersioned;this.editFieldsInfo=a.editFieldsInfo;this.ownershipBasedAccessControlForFeatures=a.ownershipBasedAccessControlForFeatures;this.editFieldsInfo&&this.ownershipBasedAccessControlForFeatures&&(this.creatorField=this.editFieldsInfo.creatorField);this.relationships=a.relationships;this.allowGeometryUpdates=q.isDefined(a.allowGeometryUpdates)?a.allowGeometryUpdates:
!0;this._isTable="Table"===this.type;for(var e=this.fields=[],t=a.fields,c=0;c<t.length;c++)e.push(new X(t[c]));if(!this.objectIdField){this.objectIdField=a.objectIdField;if(!this.objectIdField){t=a.fields;for(c=0;c<t.length;c++)if(e=t[c],"esriFieldTypeOID"===e.type){this.objectIdField=e.name;break}}this.objectIdField||console.debug("esri.layers.FeatureLayer: "+q.substitute({url:this.url},"objectIdField is not set [url: ${url}]"))}if(!q.isDefined(this._nextId)){t=this.objectIdField;e=-1;if(this._collection&&
t)for(var h=(c=this._featureSet)&&c.features,k=h?h.length:0,g,c=0;c<k;c++)g=(g=h[c].attributes)&&g[t],g>e&&(e=g);this._nextId=e+1}this.globalIdField=a.globalIdField;if(c=this.typeIdField=a.typeIdField)if(c=!this._getField(c)&&this._getField(c,!0))this.typeIdField=c.name;this.visibilityField=a.visibilityField;if(t=a.defaultSymbol)this.defaultSymbol=u.fromJson(t);var m=this.types=[],n=a.types,H,r,e=(c=this.editFieldsInfo)&&c.creatorField,h=c&&c.editorField;g=e||h;k=[];if(n)for(c=0;c<n.length;c++)H=
new Z(n[c]),r=H.templates,g&&(r&&r.length)&&(k=k.concat(r)),m.push(H);n=a.templates;H=this.templates=[];if(n)for(c=0;c<n.length;c++)m=new $(n[c]),g&&k.push(m),H.push(m);for(c=0;c<k.length;c++)if(g=l.getObject("prototype.attributes",!1,k[c]))e&&delete g[e],h&&delete g[h];if(c=a.timeInfo)this.timeInfo=new Y(c),this._startTimeField=c.startTimeField,this._endTimeField=c.endTimeField,this._startTimeField&&this._endTimeField&&(this._twoTimeFields=!0),this._trackIdField?c.trackIdField=this._trackIdField:
this._trackIdField=c.trackIdField;this.hasAttachments=!this._collection&&a.hasAttachments?!0:!1;this.htmlPopupType=a.htmlPopupType;var c=a.drawingInfo,p;if((e=c&&c.labelingInfo)&&!this.labelingInfo)this.labelingInfo=f.map(e,function(a){return new aa(a)}),this._fixLabelExpr();if(!this.renderer)if(c&&c.renderer){if(p=c.renderer,this.setRenderer(T.fromJson(p)),"classBreaks"===p.type&&this.renderer.setMaxInclusive(!0),!this._collection){var y=p.type,t=[];p=this.renderer;switch(y){case "simple":t.push(p.symbol);
break;case "uniqueValue":case "classBreaks":t.push(p.defaultSymbol),t=t.concat(f.map(p.infos,function(a){return a.symbol}))}var t=f.filter(t,q.isDefined),D=this._url.path+"/images/",O=this._getToken();f.forEach(t,function(a){var b=a.url;b&&(-1===b.search(/https?\:/)&&-1===b.indexOf("data:")&&(a.url=D+b),O&&-1!==a.url.search(/https?\:/)&&(a.url+="?token\x3d"+O))})}}else if(t)n=this.types,0<n.length?(p=new S(this.defaultSymbol,this.typeIdField),f.forEach(n,function(a){p.addValue(a.id,a.symbol)})):p=
new x(this.defaultSymbol),this.setRenderer(p);else if(!this._isTable){switch(this.geometryType){case "esriGeometryPoint":case "esriGeometryMultipoint":y=new Q;break;case "esriGeometryPolyline":y=new R;break;case "esriGeometryPolygon":y=new w;break;default:this.hasXYFootprint()&&(y=new w)}this.setRenderer(y?new x(y):null)}y=c&&c.transparency||0;!this.hasOwnProperty("opacity")&&0<y&&(this.opacity=1-y/100);this.version=a.currentVersion;this.version||(this.version="capabilities"in a||"drawingInfo"in a||
"hasAttachments"in a||"htmlPopupType"in a||"relationships"in a||"timeInfo"in a||"typeIdField"in a||"types"in a?10:9.3);if((d("ie")||7<=d("trident")||d("safari"))&&this.isEditable()&&10.02>this.version)this._ts=!0;this.statistics=a.statistics;this._fixRendererFields();this._checkFields();this._updateCaps();var N=function(){this.currentMode!==z.MODE_SNAPSHOT&&(this.queryPagination=!1);this.loaded=!0;this.onLoad(this);var a=this._loadCallback;a&&(delete this._loadCallback,a(this))};this._collection?
(y=this._featureSet,this._featureSet=null,this._mode._drawFeatures(new v(y)),this._fcAdded=!0,N.call(this)):this._forceIdentity(this._limitPromise?function(){var a=this;this._limitPromise.then(function(b){a._checkMode(b)});this._limitPromise.always(function(){a._limitPromise=null;N.call(a)})}:N)}},setShowLabels:function(a){this.showLabels=a;this.onShowLabelsChange()},onShowLabelsChange:function(){},onRendererChange:function(){this.inherited(arguments);var a=this._getRenderer();this._ager=!(!a||!a.observationAger||
!a.observationRenderer);if(a){var b=[],a=f.filter([a,a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],q.isDefined);f.forEach(a,function(a){l.isFunction(a.attributeField)||b.push(a.attributeField);b.push(a.attributeField2);b.push(a.attributeField3)},this);this._rendererFields=f.filter(b,q.isDefined)}else this._rendererFields=[];this.loaded&&(this._fixRendererFields(),this._checkFields(this._rendererFields),this._collection&&(this._typesDirty=!0))},redraw:function(){this.inherited(arguments);
this._trackManager&&this._trackManager.container&&this._trackManager.container.redraw()},_evalSDRenderer:function(){this.inherited(arguments);var a=this._getRenderer();this._ager=!(!a||!a.observationAger||!a.observationRenderer);this._trackManager&&this._trackManager.container&&this._trackManager.container.setRenderer(a&&a.trackRenderer)},_setMap:function(a){var b=this.inherited(arguments),c=this._mode,d=this;c&&c.initialize(a);this.geometryType&&this.attr("data-geometry-type",this.geometryType.replace(/esriGeometry/i,
"").toLowerCase());this._addHandle=this.on("graphic-node-add",function(a){a=a.graphic.attributes;(a=d._selectedFeatures[a&&a[d.objectIdField]])&&a.attr("data-selected","")});return b},_unsetMap:function(a){var b=this._mode;b&&b.suspend();this._trackManager&&(this._trackManager.destroy(),this._trackManager=null);p.disconnect(this._zoomConnect);p.disconnect(this._addHandle);this._zoomConnect=this._addHandle=null;this._toggleTime(!1);this.inherited("_unsetMap",arguments)},refresh:function(){var a=this._mode;
a&&a.refresh()},hasXYFootprint:function(){return"esriGeometryMultiPatch"===this.geometryType&&"xyFootprint"===this.multipatchOption},getOutFields:function(){return f.filter(this._getOutFields(),function(a){return"*"===a||!!this._getField(a)},this)},setEditable:function(a){if(!this._collection)return console.log("FeatureLayer:setEditable - this functionality is not yet supported for layer in a feature service"),this;if(!this.loaded)return this._optEditable=a,this;var b=this._editable;this._editable=
a;this._updateCaps();if(b!==a)this.onCapabilitiesChange();return this},getEditCapabilities:function(a){var b={canCreate:!1,canUpdate:!1,canDelete:!1};if(!this.loaded||!this.isEditable())return b;var c=a&&a.feature;a=a&&a.userId;var d=f.map(this.capabilities?this.capabilities.toLowerCase().split(","):[],l.trim),e=-1<f.indexOf(d,"editing"),h=e&&-1<f.indexOf(d,"create"),b=e&&-1<f.indexOf(d,"update"),d=e&&-1<f.indexOf(d,"delete"),k=this.ownershipBasedAccessControlForFeatures,g=this.editFieldsInfo,m=g&&
g.creatorField,g=g&&g.realm,c=(c=c&&c.attributes)&&m?c[m]:void 0,n=!!this.userIsAdmin,m=!k||n||!(!k.allowOthersToUpdate&&!k.allowUpdateToOthers),k=!k||n||!(!k.allowOthersToDelete&&!k.allowDeleteToOthers);if(n||e&&!h&&!b&&!d)h=b=d=!0;e={canCreate:h,canUpdate:b,canDelete:d};null===c?(e.canUpdate=b&&m,e.canDelete=d&&k):""!==c&&c&&((a=a||this.getUserId())&&g&&(a=a+"@"+g),a.toLowerCase()!==c.toLowerCase()&&(e.canUpdate=b&&m,e.canDelete=d&&k));return e},getUserId:function(){var a;this.loaded&&(a=this.credential&&
this.credential.userId||this.userId||"");return a},setUserIsAdmin:function(a){this.userIsAdmin=a},setEditSummaryCallback:function(a){this.editSummaryCallback=a},getEditSummary:function(a,b,c){c=q.isDefined(c)?c:(new Date).getTime();var d="";c=this.getEditInfo(a,b,c);(b=b&&b.callback||this.editSummaryCallback)&&(c=b(a,c)||"");if(l.isString(c))d=c;else{if(c){a=c.action;b=c.userId;var e=c.timeValue,f=0;a&&f++;b&&f++;q.isDefined(e)&&f++;1<f&&(d=("edit"===a?"edit":"create")+(b?"User":"")+(q.isDefined(e)?
c.displayPattern:""))}d=d&&q.substitute(c,this.i18n.layers.FeatureLayer[d])}return d},getEditInfo:function(a,b,c){if(this.loaded){c=q.isDefined(c)?c:(new Date).getTime();b=b&&b.action||"last";var d=this.editFieldsInfo,e=d&&d.creatorField,f=d&&d.creationDateField,h=d&&d.editorField,d=d&&d.editDateField,h=(a=a&&a.attributes)&&h?a[h]:void 0,d=a&&d?a[d]:null,e=this._getEditData(a&&e?a[e]:void 0,a&&f?a[f]:null,c);c=this._getEditData(h,d,c);var l;switch(b){case "creation":l=e;break;case "edit":l=c;break;
case "last":l=c||e}l&&(l.action=l===c?"edit":"creation");return l}},_getEditData:function(b,c,d){var e,f,l;q.isDefined(c)&&(f=d-c,l=0>f?"Full":6E4>f?"Seconds":12E4>f?"Minute":36E5>f?"Minutes":72E5>f?"Hour":864E5>f?"Hours":6048E5>f?"WeekDay":"Full");if(void 0!==b||l)e=e||{},e.userId=b,l&&(b=a.format,d=new Date(c),e.minutes=Math.floor(f/6E4),e.hours=Math.floor(f/36E5),e.weekDay=b(d,{datePattern:"EEEE",selector:"date"}),e.formattedDate=b(d,{selector:"date"}),e.formattedTime=b(d,{selector:"time"}),e.displayPattern=
l,e.timeValue=c);return e},isEditable:function(){return!(!this._editable&&!this.userIsAdmin)},setMaxAllowableOffset:function(a){this.isEditable()||(this._maxOffset=a);return this},getMaxAllowableOffset:function(){return this._maxOffset},setAutoGeneralize:function(a){if(this.loaded){if(!this.isEditable()&&this.currentMode!==z.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||this.hasXYFootprint()))if(this._autoGeneralize=a){if((a=this._map)&&a.loaded)this._maxOffset=
Math.floor(a.extent.getWidth()/a.width)}else delete this._maxOffset}else this._optAutoGen=a;return this},setGDBVersion:function(a){if(!this._collection&&a!==this.gdbVersion&&(a||this.gdbVersion))this.gdbVersion=a,this._task.gdbVersion=a,this._url.query=l.mixin(this._url.query,{gdbVersion:a}),this.loaded&&(this.clearSelection(),this._map&&this.refresh()),this.onGDBVersionChange();return this},setDefinitionExpression:function(a){this._defnExpr=a;(a=this._mode)&&a.propertyChangeHandler(1);return this},
getDefinitionExpression:function(){return this._defnExpr},setTimeDefinition:function(a){this._isSnapshot?(this._timeDefn=a,(a=this._mode)&&a.propertyChangeHandler(2)):console.log("FeatureLayer.setTimeDefinition: layer in on-demand or selection mode does not support time definitions. Layer id \x3d "+this.id+", Layer URL \x3d "+this.url);return this},getTimeDefinition:function(){return this._timeDefn},setTimeOffset:function(a,b){this._timeOffset=a;this._timeOffsetUnits=b;var c=this._mode;c&&c.propertyChangeHandler(0);
return this},setUseMapTime:function(a){this.useMapTime=a;this._toggleTime(!this.suspended);(a=this._mode)&&a.propertyChangeHandler(0)},selectFeatures:function(a,b,c,d){b=b||z.SELECTION_NEW;a=this._getShallowClone(a);var f=this._map,l,h=this,k=B._fixDfd(new e(B._dfdCanceller));a.outFields=this.getOutFields();a.returnGeometry=!0;a.multipatchOption=this.multipatchOption;f&&(a.outSpatialReference=new K(f.spatialReference.toJson()));if(!this._applyQueryFilters(a,!0))return l={features:[]},this._selectHandler(l,
b,c,d,k),k;if(f=this._canDoClientSideQuery(a))k._pendingDfd=m(this._doQuery(a,f)),k._pendingDfd.then(function(a){l={features:a};h._selectHandler(l,b,c,d,k)});else{if(this._collection)return this._resolve([Error("FeatureLayer::selectFeatures - "+this.invalidParams)],null,d,k,!0),k;var g=this;this._ts&&(a._ts=(new Date).getTime());(k._pendingDfd=this._task.execute(a)).addCallbacks(function(a){g._selectHandler(a,b,c,d,k)},function(a){g._resolve([a],null,d,k,!0)})}return k},getSelectedFeatures:function(){var a=
this._selectedFeatures,b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b},clearSelection:function(a){var b=this._selectedFeatures,c=this._mode,d;for(d in b)b.hasOwnProperty(d)&&(this._unSelectFeatureIIf(d,c),c._removeFeatureIIf(d));this._selectedFeatures={};this._isSelOnly&&c._applyTimeFilter(!0);if(!a)this.onSelectionClear();return this},setSelectionSymbol:function(a){if(this._selectionSymbol=a){var b=this._selectedFeatures,c;for(c in b)b.hasOwnProperty(c)&&b[c].setSymbol(a)}return this},
getSelectionSymbol:function(){return this._selectionSymbol},setLabelingInfo:function(a){a?(this.labelingInfo=a,this._fixLabelExpr()):delete this.labelingInfo;this._collection&&(this._typesDirty=!0);this.onLabelingInfoChange()},_fixLabelExpr:function(){var a=/\[([^\[\]]+)\]/ig,b,c=this,d=function(a,b){var d=c._getField(b,!0);return"["+(d&&d.name||b)+"]"};f.forEach(this.labelingInfo,function(c){if(b=c.labelExpression)c.labelExpression=b.replace(a,d)})},__msigns:[{n:"applyEdits",c:5,a:[{i:0},{i:1}],
e:4,f:1}],applyEdits:function(a,b,c,d,e,h){var k=h.assembly,g=h.dfd;this._applyNormalized(a,k&&k[0]);this._applyNormalized(b,k&&k[1]);this.onBeforeApplyEdits(a,b,c);var m={},n=this.objectIdField,k={f:"json"},q=!1;if(this._collection)h={},h.addResults=a?f.map(a,function(){q=!0;return{objectId:this._nextId++,success:!0}},this):null,h.updateResults=b?f.map(b,function(a){q=!0;var b=a.attributes[n];m[b]=a;return{objectId:b,success:!0}},this):null,h.deleteResults=c?f.map(c,function(a){q=!0;return{objectId:a.attributes[n],
success:!0}},this):null,q?this._editHandler(h,a,m,d,e,g):this._resolve([h.addResults,h.updateResults,h.deleteResults],null,d,g);else{a&&0<a.length&&(k.adds=this._convertFeaturesToJson(a,0,1),q=!0);if(b&&0<b.length){for(h=0;h<b.length;h++){var p=b[h];m[p.attributes[n]]=p}k.updates=this._convertFeaturesToJson(b,0,0,1);q=!0}if(c&&0<c.length){b=[];for(h=0;h<c.length;h++)b.push(c[h].attributes[n]);k.deletes=b.join(",");q=!0}if(q){var r=this;return F({url:this._url.path+"/applyEdits",content:l.mixin(k,
this._url.query),callbackParamName:"callback",load:function(b){r._editHandler(b,a,m,d,e,g)},error:function(a){r._resolve([a],null,e,g,!0)}},{usePost:!0})}this._resolve([],null,d,g)}},queryFeatures:function(a,b,c){return this._query("execute","onQueryFeaturesComplete",a,b,c)},queryRelatedFeatures:function(a,b,c){return this._query("executeRelationshipQuery","onQueryRelatedFeaturesComplete",a,b,c)},queryIds:function(a,b,c){return this._query("executeForIds","onQueryIdsComplete",a,b,c)},queryCount:function(a,
b,c){return this._query("executeForCount","onQueryCountComplete",a,b,c)},queryExtent:function(a,b,c){return this._query("executeForExtent","onQueryExtentComplete",a,b,c)},queryAttachmentInfos:function(a,b,d){var h=this._url.path+"/"+a+"/attachments",k=new e(B._dfdCanceller),g=this;k._pendingDfd=F({url:h,content:l.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:function(d){d=d.attachmentInfos;var e;f.forEach(d,function(b){e=c.objectToQuery({gdbVersion:g._url.query&&g._url.query.gdbVersion,
layer:g._url.query&&g._url.query.layer,token:g._getToken()});b.url=h+"/"+b.id+(e?"?"+e:"");b.objectId=a});g._resolve([d],"onQueryAttachmentInfosComplete",b,k)},error:function(a){g._resolve([a],null,d,k,!0)}});return k},addAttachment:function(a,b,c,d){return this._sendAttachment("add",a,b,c,d)},updateAttachment:function(a,c,d,e,f){d.appendChild(b.create("input",{type:"hidden",name:"attachmentId",value:c}));return this._sendAttachment("update",a,d,e,f)},deleteAttachments:function(a,b,c,d){var h=this._url.path+
"/"+a+"/deleteAttachments",k=new e(B._dfdCanceller),g=this;b={f:"json",attachmentIds:b.join(",")};k._pendingDfd=F({url:h,content:l.mixin(b,this._url.query),callbackParamName:"callback",load:l.hitch(this,function(b){b=b.deleteAttachmentResults;b=f.map(b,function(b){b=new G(b);b.attachmentId=b.objectId;b.objectId=a;return b});g._resolve([b],"onDeleteAttachmentsComplete",c,k)}),error:function(a){g._resolve([a],null,d,k,!0)}},{usePost:!0});return k},addType:function(a){var b=this.types;if(b){if(f.some(b,
function(b){return b.id==a.id?!0:!1}))return!1;b.push(a)}else this.types=[a];return this._typesDirty=!0},deleteType:function(a){if(this._collection){var b=this.types;if(b){var c=-1;f.some(b,function(b,d){return b.id==a?(c=d,!0):!1});if(-1<c)return this._typesDirty=!0,b.splice(c,1)[0]}}},toJson:function(){var a=this._json;if(a=l.isString(a)?s.fromJson(a):l.clone(a)){var a=a.layerDefinition?a:{layerDefinition:a},b=a.layerDefinition,c=this._collection;if(c&&this._typesDirty){b.types=f.map(this.types||
[],function(a){return a.toJson()});var d=this.renderer,e=this.labelingInfo,h=b.drawingInfo;if((d||e)&&!h)h=b.drawingInfo={};h&&(d&&-1===d.declaredClass.indexOf("TemporalRenderer"))&&(h.renderer=d.toJson());e&&(h.labelingInfo=f.map(e,function(a){return a.toJson()}))}d=null;if(!c||this._fcAdded)d={geometryType:b.geometryType,features:this._convertFeaturesToJson(this.graphics,!0)};a.featureSet=l.mixin({},a.featureSet||{},d);c&&(a.nextObjectId=this._nextId,b.capabilities=this.capabilities);return a}},
onSelectionComplete:function(){},onSelectionClear:function(){},onBeforeApplyEdits:function(){},onEditsComplete:function(){},onQueryFeaturesComplete:function(){},onQueryRelatedFeaturesComplete:function(){},onQueryIdsComplete:function(){},onQueryCountComplete:function(){},onQueryExtentComplete:function(){},onQueryAttachmentInfosComplete:function(){},onAddAttachmentComplete:function(){},onUpdateAttachmentComplete:function(){},onDeleteAttachmentsComplete:function(){},onCapabilitiesChange:function(){},
onGDBVersionChange:function(){},onQueryLimitExceeded:function(){},onLabelingInfoChange:function(){},_forceIdentity:function(a){var b=this,c=this._url&&this._url.path;(this.ownershipBasedAccessControlForFeatures||this.userIsAdmin)&&!this._getToken()&&c&&h.id&&h.id._hasPortalSession()&&h.id._doPortalSignIn(c)?h.id.getCredential(c).then(function(){b._findCredential();a.call(b)},function(){a.call(b)}):a.call(this)},_checkMode:function(a){var b=this.geometryType,c=this.maxRecordCount;a=(a=a&&a.features&&
a.features[0])&&a.attributes&&a.attributes.exceedslimit;if(this.mode===z.MODE_AUTO&&!this.isEditable()&&0===a&&(this.queryPagination||("esriGeometryPolyline"===b||"esriGeometryPolygon"===b||"esriGeometryMultipoint"===b||this.hasXYFootprint())&&c>=this.maxRecordCountForAuto||"esriGeometryPoint"===b&&c>=this.maxPointCountForAuto))this.currentMode=z.MODE_SNAPSHOT,this._mode=new M(this),this._isSnapshot=!0,this._autoGeneralize=!1},_queryLimit:function(){var a=this,b=new e;this._limitPromise=b.promise;
setTimeout(function(){var c=new L,d=new C;d.statisticType="exceedslimit";d.maxPointCount=a.maxPointCountForAuto;d.maxRecordCount=a.maxRecordCountForAuto;d.maxVertexCount=a.maxVertexCountForAuto;d.outStatisticFieldName="exceedslimit";c.outStatistics=[d];a.queryFeatures(c).promise.then(function(a){b.resolve(a)},function(a){b.reject(a)})},0)},_updateCaps:function(){var a=this._editable,b=l.trim(this.capabilities||""),c=f.map(b?b.split(","):[],l.trim),d=f.map(b?b.toLowerCase().split(","):[],l.trim),b=
f.indexOf(d,"editing"),e,d={Create:f.indexOf(d,"create"),Update:f.indexOf(d,"update"),Delete:f.indexOf(d,"delete")};if(a&&-1===b)c.push("Editing");else if(!a&&-1<b){a=[b];for(e in d)-1<d[e]&&a.push(d[e]);a.sort();for(e=a.length-1;0<=e;e--)c.splice(a[e],1)}this.capabilities=c.join(",")},_counter:{value:0},_getUniqueId:function(){return this._counter.value++},onSuspend:function(){this.inherited(arguments);this._toggleTime(!1);var a=this._mode;a&&a.suspend()},onResume:function(a){this.inherited(arguments);
this._toggleTime(!0);this._updateMaxOffset();var b=this._mode,c=this._map,d=this._getRenderer();if(a.firstOccurrence){this._fixRendererFields();this._checkFields();this.clearSelection();if(this.timeInfo&&!this._trackManager&&(this._trackIdField||d&&(d.latestObservationRenderer||d.trackRenderer)))this._trackManager=new ea(this),this._trackManager.initialize(c);d&&("colors"in d&&"blurRadius"in d&&"maxPixelIntensity"in d)&&"esriGeometryPoint"==this.geometryType&&(this._heatmapManager=new fa(this),this._heatmapManager.initialize(c));
if(this.mode===z.MODE_AUTO&&this.currentMode===z.MODE_SNAPSHOT&&("esriGeometryPolyline"===this.geometryType||"esriGeometryPolygon"===this.geometryType||this.hasXYFootprint())&&!this.getMaxAllowableOffset())d=this.generalizeForScale,d=this.maxScale?this.maxScale:this.minScale?Math.min(d,this.minScale):Math.min(d,V.getScale(c,this.initialExtent)),this.setMaxAllowableOffset(c.extent.getWidth()/c.width/c.getScale()*d);this._zoomConnect=p.connect(c,"onZoomEnd",this,this._updateMaxOffset)}b&&(a.firstOccurrence?
b.startup():b.resume())},_updateMaxOffset:function(){var a=this._map;a&&a.loaded&&this._autoGeneralize&&(this._maxOffset=Math.floor(a.extent.getWidth()/a.width))},_toggleTime:function(a){var b=this._map;a&&this.timeInfo&&this.useMapTime&&b?(this._mapTimeExtent=b.timeExtent,this._timeConnect||(this._timeConnect=p.connect(b,"onTimeExtentChange",this,this._timeChangeHandler))):(this._mapTimeExtent=null,p.disconnect(this._timeConnect),this._timeConnect=null)},_timeChangeHandler:function(a){this._mapTimeExtent=
a;(a=this._mode)&&a.propertyChangeHandler(0)},_getOffsettedTE:function(a){var b=this._timeOffset,c=this._timeOffsetUnits;return a&&b&&c?a.offset(-1*b,c):a},_getTimeOverlap:function(a,b){return a&&b?a.intersection(b):a||b},_getTimeFilter:function(a){var b=this.getTimeDefinition(),c;if(b&&(c=this._getTimeOverlap(b,null),!c))return[!1];if(a){if(a=c?this._getTimeOverlap(a,c):a,!a)return[!1]}else a=c;return[!0,a]},_getAttributeFilter:function(a){var b=this.getDefinitionExpression();return a?b?"("+b+") AND ("+
a+")":a:b},_applyQueryFilters:function(a,b){a.where=this._getAttributeFilter(a.where);a.maxAllowableOffset=this._maxOffset;b&&this.supportsAdvancedQueries&&(a.orderByFields=a.orderByFields||this.getOrderByFields());if(this.timeInfo){var c=this._getTimeFilter(a.timeExtent);if(c[0])a.timeExtent=c[1];else return!1}return!0},_add:function(a){var b=this._selectionSymbol,c=a.attributes,d=this.visibilityField;b&&this._isSelOnly&&a.setSymbol(b);if(d&&c&&c.hasOwnProperty(d))a[c[d]?"show":"hide"]();return this.add.apply(this,
arguments)},_remove:function(){return this.remove.apply(this,arguments)},_canDoClientSideQuery:function(a){var b=[],c=this._map;if(!(this._isTable||!c&&!this._collection))if(!a.text&&!(a.where&&a.where!==this.getDefinitionExpression()||a.orderByFields&&a.orderByFields.length||a.outStatistics||a.returnDistinctValues)){var d=this._isSnapshot,e=this._isSelOnly,h=a.geometry;if(h)if(!e&&a.spatialRelationship===L.SPATIAL_REL_INTERSECTS&&"extent"===h.type&&(d||c.extent.contains(h)))b.push(1);else return;
if(c=a.objectIds)if(d)b.push(2);else{var h=c.length,k=this._mode,l=0,g;for(g=0;g<h;g++)k._getFeature(c[g])&&l++;if(l===h)b.push(2);else return}if(this.timeInfo)if(a=a.timeExtent,c=this._mapTimeExtent,d)a&&b.push(3);else if(e){if(a)return}else if(c)if(-1!==f.indexOf(b,2))a&&b.push(3);else return;else if(0<b.length)a&&b.push(3);else if(a)return;return 0<b.length?b:null}},_getAbsMid:function(a){return g.toAbsMid?g.toAbsMid(a):n.id.replace(/\/[^\/]*$/ig,"/")+a},_doQuery:function(a,b,c){var d=[],h=this._mode,
k=this.objectIdField,g=this,m,n,q=new e,p=new e,r=function(a,b){if(!a.length||!b.length)return a.length?a:b;var c,d,e={};a.length>b.length?(d=a,c=b):(d=b,c=a);for(var f=d.length,h=c.length,l;f--;)l=d[f],e[l.attributes[k]]=!0;for(;h--;)l=c[h],e[l.attributes[k]]||d.push(l);return d};if(-1!==f.indexOf(b,1)){n=this.graphics;m=n.length;var s=this.spatialIndex||this._map&&this._map.spatialIndex,y,D=a.geometry._normalize(null,!0);null==s&&ha.autoSpatialIndexing?y=(this._map||this).addPlugin(this._getAbsMid("../plugins/spatialIndex")).then(l.hitch(this,
l.partial(this._getFromIndex,D,s)),function(a){p.resolve(l.hitch(this,l.partial(this._filterByExtent,n,D)))}):s&&(y=this._getFromIndex(D,s));y?y.then(function(a){for(var b=0;b<a.length;b++)a[b].results&&(d=d.concat(a[b].results));p.resolve(d)}).otherwise(function(a){p.reject(a)}):p.resolve(this._filterByExtent(n,D))}else p.resolve([]);p.then(function(d){var e=[];if(-1!==f.indexOf(b,2)){var l=a.objectIds;for(m=l.length;m--;){var t=h._getFeature(l[m]);t&&e.push(t)}e=r(d,e)}else e=d;-1!==f.indexOf(b,
3)&&g.timeInfo&&(d=a.timeExtent,e=g._filterByTime(0<e.length?e:g.graphics,d.startTime,d.endTime).match);c&&(e=f.map(e,function(a){return a.attributes[k]},this));q.resolve(e)});return q},_getFromIndex:function(a,b){b=b||this.spatialIndex||this._map.spatialIndex;a instanceof Array||(a=[a]);var c=this.id;return E(f.map(a,function(a){return b.intersects(a,c)}))},_filterByExtent:function(a,b){for(var c=[],d=0,e=a.length;d<e;d++){var f=a[d],h=f.geometry;h&&(this.normalization&&b.length?(b[0].intersects(h)||
b[1].intersects(h))&&c.push(f):b.intersects(h)&&c.push(f))}return c},_filterByTime:function(a,b,c){var d=this._startTimeField,e=this._endTimeField,f;this._twoTimeFields||(f=d||e);var h=q.isDefined,l=[],k=[],g,m=a.length,n,p;b=b?b.getTime():-Infinity;c=c?c.getTime():Infinity;if(f)for(g=0;g<m;g++)n=a[g],p=n.attributes,d=p[f],d>=b&&d<=c?l.push(n):k.push(n);else for(g=0;g<m;g++)n=a[g],p=n.attributes,f=p[d],p=p[e],f=h(f)?f:-Infinity,p=h(p)?p:Infinity,f>=b&&f<=c||p>=b&&p<=c||b>=f&&c<=p?l.push(n):k.push(n);
return{match:l,noMatch:k}},_resolve:function(a,b,c,d,e){b&&this[b].apply(this,a);c&&c.apply(null,a);d&&B._resDfd(d,a,e)},_getShallowClone:function(a){var b=new L,c;for(c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},_query:function(a,b,c,d,f){var h=this,l=this._map,k=new e(B._dfdCanceller),g=c,n=function(c,e){if(!e&&("execute"===a||"executeRelationshipQuery"===a)){var f,l;if("execute"===a){f=c.features;l=f.length;for(l-=1;0<=l;l--)if(f[l]._layer=h,!h._isTable){var g=h._mode._getFeature(f[l].attributes[h.objectIdField]);
g&&f.splice(l,1,g)}}else for(g in c)if(c.hasOwnProperty(g)){f=c[g].features;l=f.length;for(l-=1;0<=l;l--)f[l]._layer=h}}h._resolve([c],b,d,k)};if("executeRelationshipQuery"!==a){g=this._getShallowClone(c);g.outFields=this.getOutFields();g.returnGeometry=c.hasOwnProperty("returnGeometry")?c.returnGeometry:!c.outStatistics;g.returnGeometry&&(g.multipatchOption=this.multipatchOption);var p;l&&(g.outSpatialReference=new K(l.spatialReference.toJson()));if(!this._applyQueryFilters(g,"execute"===a&&!g.outStatistics)){switch(a){case "execute":p=
new v({features:[]});break;case "executeForIds":p=[];break;case "executeForCount":p=0;break;case "executeForExtent":p={}}n(p,!0);return k}if(c="executeForExtent"!==a&&this._canDoClientSideQuery(g))return k._pendingDfd=m(this._doQuery(g,c,"executeForIds"===a||"executeForCount"===a)),k._pendingDfd.then(function(b){switch(a){case "execute":p=new v;p.features=b;break;case "executeForIds":p=b;break;case "executeForCount":p=b.length}n(p,!0)}),k}if(this._collection)return this._resolve([Error("FeatureLayer::_query - "+
this.invalidParams)],null,f,k,!0),k;this._ts&&(g._ts=(new Date).getTime());(k._pendingDfd=this._task[a](g)).addCallbacks(n,function(a){h._resolve([a],null,f,k,!0)});return k},_convertFeaturesToJson:function(a,b,c,d){var e=[],h=this._selectionSymbol,k=this.visibilityField,g,m=this.objectIdField;if(this.loaded&&(c||d))g=f.filter(this.fields,function(a){return!1===a.editable&&(!d||a.name!==m)});for(c=0;c<a.length;c++){var n=a[c],p={},q=n.geometry,r=n.attributes,y=n.symbol;if(q&&(!d||!this.loaded||this.allowGeometryUpdates))p.geometry=
q.toJson();k?(p.attributes=r=l.mixin({},r),r[k]=n.visible?1:0):r&&(p.attributes=l.mixin({},r));p.attributes&&(g&&g.length)&&f.forEach(g,function(a){delete p.attributes[a.name]});y&&y!==h&&(p.symbol=y.toJson());e.push(p)}return b?e:s.toJson(e)},_selectHandler:function(a,b,c,d,e){var f;d=z;switch(b){case d.SELECTION_NEW:this.clearSelection(!0);f=!0;break;case d.SELECTION_ADD:f=!0;break;case d.SELECTION_SUBTRACT:f=!1}d=a.features;var h=this._mode,l=[],k=this.objectIdField,g,m;if(f)for(f=0;f<d.length;f++)g=
d[f],m=g.attributes[k],g=h._addFeatureIIf(m,g),l.push(g),this._selectFeatureIIf(m,g,h);else for(f=0;f<d.length;f++)g=d[f],m=g.attributes[k],this._unSelectFeatureIIf(m,h),m=h._removeFeatureIIf(m),l.push(m||g);this._isSelOnly&&h._applyTimeFilter(!0);this._resolve([l,b,a.exceededTransferLimit?{queryLimitExceeded:!0}:null],"onSelectionComplete",c,e);if(a.exceededTransferLimit)this.onQueryLimitExceeded()},_selectFeatureIIf:function(a,b,c){var d=this._selectedFeatures,e=d[a];e||(c._incRefCount(a),d[a]=
b,this._isTable||(this._setSelectSymbol(b),b.attr("data-selected","")));return e||b},_unSelectFeatureIIf:function(a,b){var c=this._selectedFeatures[a];c&&(b._decRefCount(a),delete this._selectedFeatures[a],this._isTable||(this._setUnSelectSymbol(c),c.attr("data-selected")));return c},_isSelected:function(a){},_setSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&a.setSymbol(b)},_setUnSelectSymbol:function(a){var b=this._selectionSymbol;b&&!this._isSelOnly&&b===a.symbol&&a.setSymbol(null,
!0)},_getOutFields:function(){var a=[this.objectIdField,this.typeIdField,this.creatorField,this._startTimeField,this._endTimeField,this._trackIdField].concat(this._rendererFields).concat(this.dataAttributes),a=f.filter(a,function(a,b,c){return!!a&&f.indexOf(c,a)===b}),b=l.clone(this._outFields);if(b){if(-1!==f.indexOf(b,"*"))return b;f.forEach(a,function(a){-1===f.indexOf(b,a)&&b.push(a)});return b}return a},_checkFields:function(a){var b=a||this._getOutFields();f.forEach(b,function(a){"*"!==a&&(this._getField(a)||
console.debug("esri.layers.FeatureLayer: "+q.substitute({url:this.url,field:a},"unable to find '${field}' field in the layer 'fields' information [url: ${url}]")))},this);!a&&(!this._isTable&&!this._fserver&&!this._collection)&&(f.some(this.fields,function(a){return a&&"esriFieldTypeGeometry"===a.type?!0:!1})||console.debug("esri.layers.FeatureLayer: "+q.substitute({url:this.url},"unable to find a field of type 'esriFieldTypeGeometry' in the layer 'fields' information. If you are using a map service layer, features will not have geometry [url: ${url}]")))},
_fixRendererFields:function(){var a=this.renderer;this._orderBy=null;if(a&&0<this.fields.length){var b=[],c,d,a=f.filter([a,a.observationRenderer,a.latestObservationRenderer,a.trackRenderer],q.isDefined),e=[].concat(a);f.forEach(a,function(a){f.forEach(a.rendererInfos,function(a){a.renderer&&e.push(a.renderer)})});f.forEach(e,function(a){if((d=a.attributeField)&&!l.isFunction(d))if(c=!this._getField(d)&&this._getField(d,!0))a.attributeField=c.name;if(d=a.attributeField2)if(c=!this._getField(d)&&this._getField(d,
!0))a.attributeField2=c.name;if(d=a.attributeField3)if(c=!this._getField(d)&&this._getField(d,!0))a.attributeField3=c.name;l.isFunction(a.attributeField)||b.push(a.attributeField);b.push(a.attributeField2);b.push(a.attributeField3);if((d=a.rotationInfo&&a.rotationInfo.field)&&!l.isFunction(d)){if(c=!this._getField(d)&&this._getField(d,!0))d=a.rotationInfo.field=c.name;b.push(d)}if(a.proportionalSymbolInfo){if((d=a.proportionalSymbolInfo.field)&&!l.isFunction(d)){if(c=!this._getField(d)&&this._getField(d,
!0))d=a.proportionalSymbolInfo.field=c.name;b.push(d);this._orderBy||(this._orderBy=[d+" DESC"])}if((d=a.proportionalSymbolInfo.normalizationField)&&!l.isFunction(d)){if(c=!this._getField(d)&&this._getField(d,!0))d=a.proportionalSymbolInfo.normalizationField=c.name;b.push(d)}}if(a.colorInfo){if((d=a.colorInfo.field)&&!l.isFunction(d)){if(c=!this._getField(d)&&this._getField(d,!0))d=a.colorInfo.field=c.name;b.push(d)}if((d=a.colorInfo.normalizationField)&&!l.isFunction(d)){if(c=!this._getField(d)&&
this._getField(d,!0))d=a.colorInfo.normalizationField=c.name;b.push(d)}}if(a.field&&(d=a.field)&&!l.isFunction(d)){if(c=!this._getField(d)&&this._getField(d,!0))d=a.field=c.name;b.push(d)}if(a.opacityInfo){if((d=a.opacityInfo.field)&&!l.isFunction(d)){if(c=!this._getField(d)&&this._getField(d,!0))d=a.opacityInfo.field=c.name;b.push(d)}if((d=a.opacityInfo.normalizationField)&&!l.isFunction(d)){if(c=!this._getField(d)&&this._getField(d,!0))d=a.opacityInfo.normalizationField=c.name;b.push(d)}}if(!this._orderBy&&
a.addBreak&&!l.isFunction(a.attributeField)&&(a.backgroundFillSymbol||this._hasSizeDiff(a)))this._orderBy=[a.attributeField+" DESC"]},this);this._rendererFields=f.filter(b,q.isDefined)}},_hasSizeDiff:function(a){var b=Number.MAX_VALUE,c=-Number.MAX_VALUE,d,e;f.forEach(a.infos,function(a){if(e=a.symbol){d=0;switch(e.type){case "simplemarkersymbol":d=e.size;break;case "picturemarkersymbol":d=(e.width+e.height)/2;break;case "simplelinesymbol":case "cartographiclinesymbol":d=e.width;break;case "simplefillsymbol":case "picturefillsymbol":d=
e.outline&&e.outline.width}d&&(b=Math.min(b,d),c=Math.max(c,d))}});return b!==Number.MAX_VALUE&&c!==-Number.MAX_VALUE&&1<Math.abs(c-b)},getOrderByFields:function(){var a=this.orderByFields||this._orderBy;return this.supportsAdvancedQueries&&a?f.filter(a,function(a){a=a.split(" ")[0];return!!this._getField(a,!0)},this):null},_getField:function(a,b){var c=this.fields;if(!c||0===c.length)return null;var d;b&&(a=a.toLowerCase());f.some(c,function(c){var e=!1;(e=b?c&&c.name.toLowerCase()===a?!0:!1:c&&
c.name===a?!0:!1)&&(d=c);return e});return d},_getDateOpts:function(){this._dtOpts||(this._dtOpts={properties:f.map(f.filter(this.fields,function(a){return!!(a&&"esriFieldTypeDate"===a.type)}),function(a){return a.name})});return this._dtOpts},_applyNormalized:function(a,b){a&&b&&f.forEach(a,function(a,c){a&&b[c]&&a.setGeometry(b[c])})},_editHandler:function(a,b,c,d,e,h){e=a.addResults;var l=a.updateResults;a=a.deleteResults;var g,k,m,n,p=this.objectIdField,q=this._mode,r=this._isTable;g=this.editFieldsInfo;
var s=this.getOutFields()||[],u=g&&g.creatorField,v=g&&g.creationDateField,w=g&&g.editorField,x=g&&g.editDateField;g=g&&g.realm;-1===f.indexOf(s,"*")&&(u&&-1===f.indexOf(s,u)&&(u=null),v&&-1===f.indexOf(s,v)&&(v=null),w&&-1===f.indexOf(s,w)&&(w=null),x&&-1===f.indexOf(s,x)&&(x=null));var s=v||x?(new Date).getTime():null,A=u||w?this.getUserId():void 0;A&&g&&(A=A+"@"+g);if(e)for(g=0;g<e.length;g++)e[g]=new G(e[g]),r||(k=e[g],k.success&&(k=k.objectId,m=b[g],(n=m._graphicsLayer)&&n!==this&&n.remove(m),
n=m.attributes||{},n[p]=k,u&&(n[u]=A),w&&(n[w]=A),v&&(n[v]=s),x&&(n[x]=s),m.setAttributes(n),q._init&&q.drawFeature(m)));if(l)for(g=0;g<l.length;g++)if(l[g]=new G(l[g]),!r&&(k=l[g],k.success)){k=k.objectId;m=c[k];if(b=q._getFeature(k))b.geometry!==m.geometry&&b.setGeometry(J.fromJson(m.geometry.toJson())),this._repaint(b,k);m=b||m;n=m.attributes||{};w&&(n[w]=A);x&&(n[x]=s);m.setAttributes(n)}if(a){c=[];for(g=0;g<a.length;g++)if(a[g]=new G(a[g]),!r&&(k=a[g],k.success&&(k=k.objectId,m=q._getFeature(k))))this._unSelectFeatureIIf(k,
q)&&c.push(m),m._count=0,q._removeFeatureIIf(k);if(0<c.length)this.onSelectionComplete(c,z.SELECTION_SUBTRACT)}this._resolve([e,l,a],"onEditsComplete",d,h)},_sendAttachment:function(a,b,c,d,e){var f=this;return F({url:this._url.path+"/"+b+"/"+("add"===a?"addAttachment":"updateAttachment"),form:c,content:l.mixin(this._url.query,{f:"json",token:this._getToken()||void 0}),callbackParamName:"callback.html",handleAs:"json"}).addCallback(function(c){var e="add"===a?"onAddAttachmentComplete":"onUpdateAttachmentComplete";
c=new G(c["add"===a?"addAttachmentResult":"updateAttachmentResult"]);c.attachmentId=c.objectId;c.objectId=b;f._resolve([c],e,d);return c}).addErrback(function(a){f._resolve([a],null,e,null,!0)})},_repaint:function(a,b,c){b=q.isDefined(b)?b:a.attributes[this.objectIdField];(!(b in this._selectedFeatures)||!this._selectionSymbol)&&a.setSymbol(a.symbol,c)},_getKind:function(a){var b=this._trackManager;return b?b.isLatestObservation(a)?1:0:0}});l.mixin(z,{MODE_SNAPSHOT:0,MODE_ONDEMAND:1,MODE_SELECTION:2,
SELECTION_NEW:3,SELECTION_ADD:4,SELECTION_SUBTRACT:5,MODE_AUTO:6,MODE_STREAM:7,POPUP_NONE:"esriServerHTMLPopupTypeNone",POPUP_HTML_TEXT:"esriServerHTMLPopupTypeAsHTMLText",POPUP_URL:"esriServerHTMLPopupTypeAsURL"});A._createWrappers(z);d("extend-esri")&&l.setObject("layers.FeatureLayer",z,h);return z});