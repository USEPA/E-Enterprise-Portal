{"version":3,"sources":["air_emissions.js"],"names":["$","wrap","text","width","each","word","d3","select","this","words","split","reverse","line","lineNumber","lineHeight","x","attr","y","dy","parseFloat","tspan","append","pop","push","join","node","getComputedTextLength","insertLinebreaks","el","anchor","i","length","html","baseDy","insertSubscripts","parts","match","style","document","ready","draw","drawDonut","data","svg","height","totalWidth","emissionsNumberFormat","format","radius","Math","min","color","scale","ordinal","range","totalEmissions","Facilities","forEach","facility","TotEmissCO2E","arc","outerRadius","innerRadius","outerArc","pie","layout","sort","value","d","donut","g","selectAll","enter","labels","centroid","midAngle","atan2","cos","sign","labelX","sin","text-anchor","FacName","call","co2eLabel","parentNode","FacDistMi","totalEmissionsText","lowestLabel","getBoundingClientRect","bottom","clientHeight","drawChart","maxDistance","maxCO2E","facIDMap","uniqueGases","FacID","Pollutants","pollutant","PollutantName","y0","sections","map","name","y1","AmtCO2E","gasClassMap","PFC","HFC","NF3","SF6","N2O","CH4","CO2","margin","top","right","left","extraHeight","donutWidth","donutHeight","totalHeight","rangeRoundBands","domain","linear","xAxis","axis","tickFormat","orient","yAxis","ticks","tickSize","graph","yAxisGroup","xAxisLabels","rangeBand","tspans","legend","offset","legendItem","Object","keys","ZipCentLat83","ZipCentLong83","BuffRadiusMi","FacLat83","FacLong83","jQuery"],"mappings":"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","file":"air_emissions.js","sourcesContent":["(function ($) {\r\n  \"use strict\";\r\n\r\n  $(document).ready(function () { draw(); });\r\n\r\n    var baseDy = 18;\r\n\r\n    function wrap(text, width) {\r\n      text.each(function() {\r\n        var text = d3.select(this),\r\n            words = text.text().split(/\\s+/).reverse(),\r\n            word,\r\n            line = [],\r\n            lineNumber = 0,\r\n            lineHeight = 1.1, // ems\r\n            x = text.attr(\"x\"),\r\n            y = text.attr(\"y\")?text.attr(\"y\"):0,\r\n            dy = parseFloat(text.attr(\"dy\")),\r\n            tspan = text.text(null).append(\"tspan\").attr(\"x\", x).attr(\"y\", y).attr(\"dy\", dy + \"em\");\r\n        while (word = words.pop()) {\r\n          line.push(word);\r\n          tspan.text(line.join(\" \"));\r\n          if (tspan.node().getComputedTextLength() > width) {\r\n            line.pop();\r\n            tspan.text(line.join(\" \"));\r\n            line = [word];\r\n            tspan = text.append(\"tspan\").attr(\"x\", x).attr(\"y\", y).attr(\"dy\", ++lineNumber * lineHeight + dy + \"em\").text(word);\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n  function insertLinebreaks(text) {\r\n\r\n    text.each(function() {\r\n      var el = d3.select(this);\r\n      var words = el.text().split('/');\r\n      el.text('');\r\n\r\n      var anchor = el.attr('text-anchor');\r\n      var x = el.attr('x') ? el.attr('x') : 0;\r\n      var y = el.attr('y') ? el.attr('y') : 0;\r\n\r\n      for (var i = 0; i < words.length; i++) {\r\n        var tspan = el.append('tspan').html(words[i])\r\n          .attr('text-anchor', anchor)\r\n          .attr('x', x)\r\n          .attr('y', y)\r\n          .attr('dy', '0')\r\n        if (i > 0) {\r\n          tspan\r\n            .attr('text-anchor', anchor)\r\n            .attr('x', x)\r\n            .attr('y', y)\r\n            .attr('dy', baseDy * i);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  function insertSubscripts(text) {\r\n\r\n    text.each(function() {\r\n      var el = d3.select(this);\r\n\r\n      var parts = el.text().match(/(.*)([0-9])(.*)/);\r\n\r\n      if (parts) {\r\n        el.text('');\r\n\r\n        for (var i = 1; i < parts.length; i++) {\r\n          var tspan = el.append('tspan').text(parts[i]);\r\n          if (i == 2) { // subscript\r\n            tspan.attr(\"baseline-shift\", \"sub\");\r\n            tspan.style(\"font-size\", \"80%\")\r\n          }\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  var drawDonut = function(data, svg, width, height, totalWidth) {\r\n\r\n    var emissionsNumberFormat = d3.format(\",.0f\");\r\n\r\n    var radius = Math.min(width, height) / 2;\r\n\r\n    var color = d3.scale.ordinal()\r\n        .range([\"#857e00\", \"#f69000\", \"#a55d8c\"]);\r\n\r\n    var totalEmissions = 0;\r\n\r\n    data.Facilities.forEach(function(facility) {\r\n      totalEmissions += facility.TotEmissCO2E;\r\n    });\r\n\r\n    var arc = d3.svg.arc()\r\n        .outerRadius(radius * .7)\r\n        .innerRadius(radius * .5);\r\n\r\n    var outerArc = d3.svg.arc()\r\n      .outerRadius(radius)\r\n      .innerRadius(radius);\r\n\r\n    var pie = d3.layout.pie()\r\n        .sort(null)\r\n        .value(function(d) { return d.TotEmissCO2E; });\r\n\r\n    var svg = d3.select(\"#air-emissions-chart\").append(\"svg\")\r\n        .attr(\"viewBox\", \"0 0 \" + totalWidth + \" \" + height)\r\n        .attr(\"preserveAspectRatio\", \"xMidYMid\")\r\n        .style(\"max-width\", totalWidth + \"px\")\r\n        // .attr(\"height\", height);\r\n\r\n    var donut = svg.append(\"g\")\r\n      .attr(\"transform\", \"translate(\" + totalWidth / 2 + \",\" + height / 2 + \")\");\r\n\r\n    var g = donut.selectAll(\".arc\")\r\n        .data(pie(data.Facilities))\r\n      .enter().append(\"g\")\r\n        .attr(\"class\", \"arc\");\r\n\r\n    g.append(\"path\")\r\n        .attr(\"d\", arc)\r\n        .style(\"fill\", function(d) { return color(d.data.TotEmissCO2E); });\r\n\r\n    var labels = g.append(\"text\").attr({\r\n      x: function (d, i) {\r\n          var centroid = outerArc.centroid(d),\r\n              midAngle = Math.atan2(centroid[1], centroid[0]),\r\n              x = Math.cos(midAngle) * radius,\r\n              sign = (x > 0) ? 1 : -1,\r\n              labelX = x + (5 * sign);\r\n          return labelX;\r\n      },\r\n      y: function (d, i) {\r\n          var centroid = outerArc.centroid(d),\r\n              midAngle = Math.atan2(centroid[1], centroid[0]),\r\n              y = Math.sin(midAngle) * radius;\r\n          return y;\r\n      },\r\n      'text-anchor': function (d, i) {\r\n          var centroid = outerArc.centroid(d),\r\n              midAngle = Math.atan2(centroid[1], centroid[0]),\r\n              x = Math.cos(midAngle) * radius;\r\n          return (x > 0) ? \"start\" : \"end\";\r\n      },\r\n      dy: 0\r\n    }).text(function(d) { \r\n      return d.data.FacName; \r\n    }).call(wrap, totalWidth / 2 - radius);\r\n\r\n    var co2eLabel = labels.append(\"tspan\")\r\n      .attr(\"x\", function(){ return d3.select(this.parentNode).attr(\"x\") })\r\n      .attr(\"dy\", baseDy)\r\n      .attr(\"class\", \"emissions-watch-donut-small-subtitle\");\r\n\r\n    co2eLabel.append(\"tspan\")\r\n      .text(function(d) {\r\n        return emissionsNumberFormat(d.data.TotEmissCO2E) + ' metric tons CO';\r\n      });\r\n\r\n    co2eLabel.append(\"tspan\")\r\n      .attr(\"baseline-shift\", \"sub\")\r\n      .style(\"font-size\", \"80%\")\r\n      .text(\"2\");\r\n\r\n    co2eLabel.append(\"tspan\")\r\n      .text(\"e\");\r\n\r\n    labels.append(\"tspan\")\r\n      .text(function(d) {\r\n        return d.data.FacDistMi + ' miles away';\r\n      })\r\n      .attr(\"x\", function(){ return d3.select(this.parentNode).attr(\"x\") })\r\n      .attr(\"dy\", baseDy)\r\n      .attr(\"class\", \"emissions-watch-donut-small-subtitle\");\r\n\r\n    var totalEmissionsText = donut.append(\"text\")\r\n      .attr(\"text-anchor\", \"middle\")\r\n      .attr(\"dy\", 0)\r\n      .attr(\"y\", -9)\r\n      .attr(\"x\", 0)\r\n      .text(emissionsNumberFormat(totalEmissions));\r\n\r\n    totalEmissionsText.append(\"tspan\")\r\n      .attr(\"dy\", baseDy)\r\n      .attr(\"x\", 0)\r\n      .attr(\"class\", \"emissions-watch-donut-small-subtitle\")\r\n      .text(\"metric tons\");\r\n\r\n    totalEmissionsText.append(\"tspan\")\r\n      .attr(\"dy\", baseDy)\r\n      .attr(\"x\", 0)\r\n      .attr(\"class\", \"emissions-watch-donut-small-subtitle\")\r\n      .text(\"CO\");\r\n\r\n    totalEmissionsText.append(\"tspan\")\r\n          // .attr(\"x\", 0)\r\n          .attr(\"baseline-shift\", \"sub\")\r\n          .style(\"font-size\", \"64%\")\r\n          .attr(\"class\", \"emissions-watch-donut-small-subtitle\")\r\n          .text(\"2\");\r\n\r\n    totalEmissionsText.append(\"tspan\")\r\n          // .attr(\"x\", 0)\r\n          .attr(\"class\", \"emissions-watch-donut-small-subtitle\")\r\n          .text(\"e\");\r\n\r\n    var lowestLabel;\r\n\r\n    labels.each(function() {\r\n      if (!lowestLabel || this.getBoundingClientRect().bottom > lowestLabel.getBoundingClientRect().bottom)\r\n        lowestLabel = this;\r\n    })\r\n\r\n    // svg.attr(\"height\", height + lowestLabel.clientHeight);\r\n    svg.attr(\"viewBox\", \"0 0 \" + totalWidth + \" \" + (height + lowestLabel.clientHeight))\r\n  }\r\n\r\n  var drawChart = function(data) {\r\n\r\n    var emissionsNumberFormat = d3.format(\",.0f\");\r\n\r\n    var maxDistance = 0;\r\n    var maxCO2E = 0;\r\n\r\n    var facIDMap = {};\r\n    var uniqueGases = {};\r\n\r\n    data.Facilities.forEach(function(facility, i) {\r\n\r\n      facIDMap[facility.FacID] = i;\r\n\r\n      if (facility.FacDistMi > maxDistance)\r\n        maxDistance = facility.FacDistMi;\r\n\r\n      if (facility.TotEmissCO2E > maxCO2E)\r\n        maxCO2E = facility.TotEmissCO2E;\r\n\r\n      if (facility.Pollutants) {\r\n        facility.Pollutants.forEach(function(pollutant) {\r\n          uniqueGases[pollutant.PollutantName] = 1;\r\n        });\r\n      }\r\n\r\n      // TODO: handle missing pollutants case\r\n      // if (facility.Pollutants.length == 0)\r\n      //   facility.Pollutants.push({'PollutantName': 'All', AmtCO2E: facility.TotEmissCO2E});\r\n\r\n      var y0 = 0;\r\n      // prepare bar sections\r\n      facility.sections = facility.Pollutants.map(function(pollutant) { return {name: pollutant.PollutantName, y0: y0, y1: y0 += +pollutant.AmtCO2E}; });\r\n    });\r\n\r\n    var gasClassMap = {\r\n      'PFC': 'gas-pfc',\r\n      'HFC': 'gas-hfc',\r\n      'NF3': 'gas-nf3',\r\n      'SF6': 'gas-sf6',\r\n      'N2O': 'gas-n2o',\r\n      'CH4': 'gas-ch4',\r\n      'CO2': 'gas-co2'\r\n    }\r\n\r\n    // set chart sizes\r\n    var margin = {top: 0, right: 20, bottom: 100, left: 140},\r\n        width = 650 - margin.left - margin.right,\r\n        height = 300 - margin.top - margin.bottom;\r\n\r\n    var extraHeight = baseDy * 8//data.Facilities[facIDMap[d]].Pollutants.length;\r\n\r\n    margin.top += extraHeight;\r\n\r\n    var donutMargin = {bottom: 20};\r\n    var donutWidth = 200;\r\n    var donutHeight = 200;\r\n\r\n    var totalWidth = width + margin.left + margin.right;\r\n    var totalHeight = height + margin.top + margin.bottom;\r\n\r\n    drawDonut(data, svg, donutWidth, donutHeight, totalWidth);\r\n\r\n    // set x and y scales\r\n    var x = d3.scale.ordinal().rangeRoundBands([0, width], .1).domain(data.Facilities.map(function(d) { return d.FacID }));;\r\n    var y = d3.scale.linear().domain([0, maxCO2E]).range([height, 0]);\r\n\r\n    // set colors\r\n    var color = d3.scale.ordinal()\r\n        .range([\"#98abc5\", \"#8a89a6\", \"#7b6888\", \"#6b486b\", \"#a05d56\", \"#d0743c\", \"#ff8c00\"]);\r\n\r\n    // create x axis\r\n    var xAxis = d3.svg.axis()\r\n        .scale(x)\r\n        .tickFormat(function(d) {\r\n          return data.Facilities[facIDMap[d]].FacName;\r\n        })\r\n        .orient(\"bottom\");\r\n\r\n    // create y axis\r\n    var yAxis = d3.svg.axis()\r\n        .scale(y)\r\n        .orient(\"left\")\r\n        .ticks(5)\r\n        .tickSize(-width)\r\n        .tickFormat(d3.format(\".2s\"));\r\n\r\n    // append svg\r\n    var svg = d3.select(\"#air-emissions-chart\").append(\"svg\")\r\n        .attr(\"viewBox\", \"0 0 \" + totalWidth + \" \" + totalHeight)\r\n        .attr(\"preserveAspectRatio\", \"xMidYMid\")\r\n        .style(\"max-width\", totalWidth + \"px\")\r\n        // .attr(\"height\", totalHeight);\r\n\r\n    // append bar chart\r\n    var graph = svg.append(\"g\")\r\n        .attr(\"transform\", \"translate(\" + margin.left + \",\" + (margin.top) + \")\");\r\n\r\n    // y-axis\r\n    var yAxisGroup = graph.append(\"g\")\r\n        .attr(\"class\", \"y axis\")\r\n        .call(yAxis);\r\n\r\n    // bars\r\n    var facility = graph.selectAll(\".facility\")\r\n      .data(data.Facilities)\r\n      .enter().append(\"g\")\r\n        .attr(\"class\", \"g\")\r\n        .attr(\"transform\", function(d) { return \"translate(\" + x(d.FacID) + \",0)\" });\r\n\r\n    // bar sections\r\n    var bars = facility.selectAll(\"rect\")\r\n      .data(function(d) { return d.sections})\r\n      .enter().append(\"rect\")\r\n        .attr(\"width\", x.rangeBand())\r\n        .attr(\"y\", function(d) { return y(d.y1); })\r\n        .attr(\"height\", function(d) { return y(d.y0) - y(d.y1); })\r\n        .attr(\"class\", function(d) { return gasClassMap[d.name]; });\r\n\r\n    // x-axis labels\r\n    var xAxisLabels = graph.append(\"g\")\r\n        .attr(\"class\", \"x axis\")\r\n        .attr(\"transform\", \"translate(\"+ -x.rangeBand() / 2 +\",\" + height + \")\")\r\n        .call(xAxis)\r\n        .selectAll(\".tick text\")\r\n        .style(\"text-anchor\", \"start\")\r\n        .call(wrap, x.rangeBand());\r\n\r\n    // x-axis sublabels\r\n    var co2eLabel = xAxisLabels.append(\"tspan\")\r\n      // .text(function(d) {\r\n      //   return (emissionsNumberFormat(data.Facilities[facIDMap[d]].TotEmissCO2E)) + ' metric tons CO2e';\r\n      // })\r\n      .attr(\"x\", function(){ return d3.select(this.parentNode).attr(\"x\") })\r\n      .attr(\"dy\", baseDy)\r\n      .attr(\"text-anchor\", \"start\")\r\n      .attr(\"class\", \"emissions-watch-donut-small-subtitle\");\r\n\r\n    co2eLabel.append(\"tspan\")\r\n      .text(function(d) {\r\n        return emissionsNumberFormat(data.Facilities[facIDMap[d]].TotEmissCO2E) + ' metric tons CO';\r\n      });\r\n\r\n    co2eLabel.append(\"tspan\")\r\n      .attr(\"baseline-shift\", \"sub\")\r\n      .style(\"font-size\", \"80%\")\r\n      .text(\"2\");\r\n\r\n    co2eLabel.append(\"tspan\")\r\n      .text(\"e\");\r\n\r\n    // x-axis sublabels\r\n    xAxisLabels.append(\"tspan\")\r\n      .text(function(d) {\r\n        return (data.Facilities[facIDMap[d]].FacDistMi) + ' miles away';\r\n      })\r\n      .attr(\"x\", function(){ return d3.select(this.parentNode).attr(\"x\") })\r\n      .attr(\"dy\", baseDy)\r\n      .attr(\"text-anchor\", \"start\")\r\n      .attr(\"class\", \"emissions-watch-donut-small-subtitle\");\r\n\r\n    // component labels above bars\r\n    var tspans = xAxisLabels.append(\"tspan\")\r\n      .text(function(d) {\r\n        return data.Facilities[facIDMap[d]].Pollutants.reverse().map(\r\n          function(pollutant){ \r\n            return pollutant.PollutantName + \": \";\r\n          }).join('/');\r\n      }).attr(\"x\", function(){ return 0})\r\n      .attr(\"y\", function(d) { return -y(maxCO2E - data.Facilities[facIDMap[d]].TotEmissCO2E) - baseDy * data.Facilities[facIDMap[d]].Pollutants.length })\r\n      .attr(\"text-anchor\", \"start\")\r\n      .attr(\"class\", \"emissions-watch-bar-chart-small-subtitle\")\r\n      .call(insertLinebreaks)\r\n      // .call(insertSubscripts)\r\n\r\n    tspans.selectAll(\"tspan\").call(insertSubscripts);\r\n    \r\n    xAxisLabels.append(\"tspan\")\r\n      .text(function(d) {\r\n        return data.Facilities[facIDMap[d]].Pollutants.map(\r\n          function(pollutant){ \r\n            return emissionsNumberFormat(pollutant.AmtCO2E);\r\n          }).join('/');\r\n      }).attr(\"x\", function(){ return x.rangeBand()})\r\n      .attr(\"y\", function(d) { return -y(maxCO2E - data.Facilities[facIDMap[d]].TotEmissCO2E) - baseDy * data.Facilities[facIDMap[d]].Pollutants.length })\r\n      .attr(\"text-anchor\", \"end\")\r\n      .attr(\"class\", \"emissions-watch-bar-chart-small-subtitle\")\r\n      .call(insertLinebreaks);\r\n\r\n    // y axis label\r\n    yAxisGroup.append(\"text\")\r\n      .text(\"Emissions\")\r\n      .attr(\"transform\", \"translate(-140,0)\")\r\n      .style(\"font-size\", \"80%\")\r\n      .append(\"tspan\")\r\n        .text(\"(metric tons CO2e)\")\r\n        .attr(\"x\", 0)\r\n        .attr(\"dy\", baseDy)\r\n        .attr(\"class\", \"emissions-watch-bar-chart-small-subtitle\")\r\n        .call(insertSubscripts)\r\n\r\n\r\n    // legend\r\n    var legend = yAxisGroup.append(\"g\")\r\n      .attr(\"transform\", \"translate(-140, 50)\")\r\n      .attr(\"class\", \"legend\");\r\n\r\n    legend.append(\"text\").text(\"Legend\").attr(\"x\", 0).attr(\"y\", 0).style(\"fill\", \"black\");\r\n\r\n    var offset = baseDy/2;\r\n\r\n    var legendItem = legend.selectAll(\"g\")\r\n      .data(Object.keys(uniqueGases))\r\n      .enter().append(\"g\")\r\n\r\n    legendItem.append(\"rect\").attr(\"width\", x.rangeBand() / 3)\r\n        .attr(\"x\", 0)\r\n        .attr(\"y\", function(d, i) { return offset + i *  baseDy; })\r\n        .attr(\"height\", baseDy)\r\n        .attr(\"class\", function(d) { return gasClassMap[d]; });\r\n\r\n    legendItem.append(\"text\").text(function(d) { return d; })\r\n      .attr(\"x\", 0)\r\n      .attr(\"y\", function(d, i) { return offset + (i+1) *  baseDy - baseDy / 3; })\r\n      .attr(\"text-anchor\", \"middle\")\r\n      .attr(\"transform\", \"translate(\"+ x.rangeBand() / 6 +\",0)\")\r\n      .call(insertSubscripts);\r\n  }\r\n\r\n  var draw = function() {\r\n    var data = { \"ZipCentLat83\": 32.8, \"ZipCentLong83\": -96.8, \"BuffRadiusMi\": 10, \"Facilities\": [ \r\n      { \"FacID\": 1001398, \"FacName\": \"Atmos Energy Corporation - Texas\", \"FacLat83\": 32.925488, \"FacLong83\": -96.816137, \"FacDistMi\": 8.72, \"TotEmissCO2E\": 544204, \"Pollutants\": [ { \"PollutantName\": \"CH4\", \"AmtCO2E\": 543549 }, { \"PollutantName\": \"CO2\", \"AmtCO2E\": 655 } ] }, \r\n      { \"FacID\": 1006817, \"FacName\": \"McCommas Bluff Landfill\", \"FacLat83\": 32.67628, \"FacLong83\": -96.73391, \"FacDistMi\": 9.37, \"TotEmissCO2E\": 420239.25, \"Pollutants\": [ { \"PollutantName\": \"CH4\", \"AmtCO2E\": 420239.25 } ] },\r\n      { \"FacID\": 1003945, \"FacName\": \"TEXAS INSTRUMENTS NORTH CAMPUS\", \"FacLat83\": 32.93311, \"FacLong83\": -96.7537, \"FacDistMi\": 9.58, \"TotEmissCO2E\": 531866.507, \"Pollutants\": [ { \"PollutantName\": \"PFC\", \"AmtCO2E\": 399276.483 }, { \"PollutantName\": \"HFC\", \"AmtCO2E\": 8872.334 }, { \"PollutantName\": \"NF3\", \"AmtCO2E\": 31682.4 }, { \"PollutantName\": \"SF6\", \"AmtCO2E\": 29906.76 }, { \"PollutantName\": \"N2O\", \"AmtCO2E\": 12737.414 }, { \"PollutantName\": \"CH4\", \"AmtCO2E\": 23 }, { \"PollutantName\": \"CO2\", \"AmtCO2E\": 49340.7 } ] }\r\n    ] };\r\n    \r\n    drawChart(data);\r\n  }\r\n\r\n})(jQuery);"]}