!function(a){function b(b){var d=a("#fmw-program-select"),e=a("#fmw-program-select-holder"),f=a("#fmw-program-single"),g=a("#fmw-type-select-holder"),i=a("#launch-facility-management"),j="",k=0;d.html('<option value="">Select&hellip;</option>'),a.each(b,function(a){d.append('<option value="'+a+'" >'+a+"</option>"),k+=1,j=a}),k>1?(d.show(),f.hide()):(d.val(j).hide(),f.html(j).show(),c(b[j])),e.show(),d.unbind("change").change(function(){var d=a(this).val();i.hide(),g.hide(),""!=d&&c(b[d]),h()})}function c(b){var c=a("#fmw-type-select"),d=a("#fmw-type-single"),e=a("#fmw-type-select-holder"),f=0,g="",i="",j=a("#launch-facility-management");c.html('<option value="">Select a Role Type</option>'),a.each(b,function(a,b){c.append('<option value="'+b.userRoleId+'" >'+b.type+"</option>"),f+=1,g=b.userRoleId,i=b.type}),f>1?(c.show(),d.hide()):(c.val(g).hide(),d.html(i).show(),j.show()),c.unbind("change").change(function(){""==a(this).val()?j.hide():j.show(),h()}),e.show()}function d(){a.ajax({url:Drupal.settings.basePath+"retrieve_cdx_user_data",success:function(c){var d=a.parseJSON(c);if(d.error)console.log("CDX Error",d),a("#fmw-organization-select-holder").html("Unable to receive user data.");else{var g=d.organizations_to_roles;if(0==g.length){var h="<p>You do not have any facilities to manage in CDX through this widget at this time.</p>";a("#fmw-organization-select-holder").html(h)}else{var j=a("#fmw-organization-select"),k=a("#fmw-organization-single"),l=a("#launch-facility-management"),n=a("#fmw-type-select-holder"),o=a("#fmw-program-select-holder");m.done(function(c){if(""==c&&(c={expired:!0}),c.expired)f();else{var d=c.token,h=c.server_ip,m=c.url,p=c.user_login_time,q=c.user_session_logout,r=0;a.each(g,function(b,c){c.roles&&a.each(c.roles,function(a,b){if(0==r){var c=b[0].userRoleId;e(c,d,h,m,p,q,0),r=1}})}),j.append('<option value="">Select an Organization</option>');var s=0,t="",u="";a.each(g,function(a,b){b.roles&&(j.append('<option value="'+a+'" >'+b.name+"</option>"),s+=1,t=a,u=b.name)}),1==s?(j.val(t).hide(),k.html(u).show(),b(g[t].roles)):j.show(),j.change(function(){var c=a(this).val();o.hide(),n.hide(),l.hide(),""!=c&&b(g[c].roles)}),l.click(function(){var b=a("#fmw-type-select").val();e(b,d,h,m,p,q,0),a("#facility-widget").length>0&&(i.dialog("open"),a(".ui-dialog").focus())})}})}}}})}function e(b,c,d,h,n,o,p){a("#facility-widget").html(""),Date.now||(Date.now=function(){return(new Date).getTime()});var q=Date.now(),r=1e3*n,s=Math.abs((q-r)/6e4);return s>=o?(f(),void i.remove()):k?(j=b,void(l=!0)):(k=!0,void a.initFacilityManagementWidget({autoScroll:!1,widgetDisplayType:"Edit My Facilities",baseServiceUrl:h,ImagesFolderPath:h+"/ContentFramework/FRS%20Widget/images",userRoleId:b,NASSToken:c,NAASip:d,onInvalidSession:function(){m.done(function(a){if(a.expired)f();else{var c=a.token;""===c?g("CDX Facility- Blank Token"):p>2?g("CDX Facility- Max attempts."):(k=!1,e(b,c,d,h,n,o,p+1))}})},onServiceCall:function(){i.dialog("option","position",{my:"center",at:"center",of:window})},onWidgetDataLoaded:function(){k=!1,l&&(e(j,c,d,h,n,o,p),l=!1)}}))}function f(){var b=a("#cdx-logged-in-options"),c=a("#cdx-logged-out-options"),d=a("#cdx-logged-out-log-out");b.remove(),c.show(),d.click(function(){window.location.href="/user/logout"})}function g(b){console.log(b);var c=a("#cdx-logged-in-options"),d=a("#cdx-unable-to-load");c.remove(),d.show()}function h(){var b=0,c=a(".pane-views-cdx-facility-management-block");a("#cdx-logged-in-options").find("div").each(function(){b+=a(this).outerWidth(!0)}),b>c.width()&&(c.parent().hasClass("expanded")&&"none"==a("#launch-facility-management").css("display")?(c.parent().height("-=40"),c.parent().removeClass("expanded")):a(".pane-views-cdx-facility-management-block").parent().hasClass("expanded")||(c.parent().height("+=40"),c.parent().addClass("expanded")))}var i,j,k=!1,l=!1,m=a.ajax({url:Drupal.settings.basePath+"return_cdx_facility_management_token",type:"JSON"});a(document).ready(function(){i=a("#facility-widget");var b=a("#first-time-user-block");i.length>0&&i.dialog({title:"My Facility Manager",modal:!0,autoOpen:!1,width:"auto",height:"auto",maxWidth:"1000px",minWidth:"1000px",dialogClass:"cdx_facility_management_block",resizable:!1,position:{my:"center",at:"center",of:window}}),a(window).resize(function(){i.dialog("option","position",{my:"center",at:"center",of:window})}),b.length>0?a(document).on("ee:first_time_user_complete",function(){d()}):d()})}(jQuery);
//# sourceMappingURL=cdx_facility_management.js.map