<?php


/**
 * Implements hook_menu().
 */
function be_well_informed_menu() {
  $items = array();
  $items['be_well_informed/form_submission'] = array(
    'page callback' => 'form_submission',
    'access callback' => TRUE,
  );
  return $items;
}


/**
 * Implements hook_block_info().
 */
function be_well_informed_block_info() {
  $blocks = array();
  $blocks['be_well_informed'] = array(
    'info' => t('Be Well Informed Block'),
  );
  return $blocks;
}

/**
 * Implements hook_theme().
 * @see http://www.devdungeon.com/content/using-tpl-template-files-custom-drupal-7-modules
 */
function be_well_informed_theme() {
  return array(
    // Name to be called with theme(). theme('be_well_informed')
    'be_well_informed' => array(
      // Default variables
      'variables' => array(),
      // Which .tpl.php file to use my-cdx.tpl.php
      'template' => 'be-well-informed',
      'path' => drupal_get_path('module', 'be_well_informed') . '/templates'
    ),
    'be_well_informed_form_submission_modal' => array(
      // Default variables
      'variables' => array(),
      // Which .tpl.php file to use my-cdx.tpl.php
      'template' => 'be-well-informed-form-submission-modal',
      'path' => drupal_get_path('module', 'be_well_informed') . '/templates'
    ),
    'be_well_informed_return_results_modal' => array(
      // Default variables
      'variables' => array(),
      // Which .tpl.php file to use my-cdx.tpl.php
      'template' => 'be-well-informed-return-results-modal',
      'path' => drupal_get_path('module', 'be_well_informed') . '/templates'
    ),
  );
}

/**
 * Implements hook_block_view().
 */
function be_well_informed_block_view($delta = '') {
  $block = array();
  if ($delta == 'be_well_informed') {
    //good idea to check user perms here
    if (user_access('access content')) {
      drupal_add_css(libraries_get_path('jqueryui') . "/themes/base/jquery.ui.tabs.css", "file");
      drupal_add_js(drupal_get_path('module', 'datatables') . '/dataTables/media/js/jquery.dataTables.js', [
        'scope' => 'footer',
        'preprocess' => TRUE,
        'group' => JS_LIBRARY,
        'type' => 'file',
        'cache' => TRUE,
        'requires_jquery' => TRUE
      ]);
      drupal_add_js(drupal_get_path('module', 'be_well_informed') . '/js/be_well_informed.js', [
        'scope' => 'footer',
        'preprocess' => TRUE,
        'group' => JS_LIBRARY,
        'type' => 'file',
        'cache' => TRUE,
        'requires_jquery' => TRUE
      ]);
      drupal_add_css(drupal_get_path('module', 'be_well_informed') . '/css/be_well_informed.css', [
        'preprocess' => TRUE,
        'group' => CSS_THEME
      ]);
      // Set Form Modal Template
      $modal_form_html = theme('be_well_informed_form_submission_modal');
      drupal_add_js(array("be_well_informed" => ["modal_form"=> $modal_form_html]), 'setting');

      // Set Form Return Modal Template
      $modal_results_html = theme('be_well_informed_return_results_modal');
      drupal_add_js(array("be_well_informed" => ["modal_results"=> $modal_results_html]), 'setting');


      $block['subject'] = t('Be Well Informed');
      $block['content'] = theme('be_well_informed');
      return $block;
    }
  }
  return $block;
}


function form_submission() {
  if (!isset($_POST)) {
    drupal_json_output(array('error' => true, 'message' => 'Failed to recieve any data.'));
    return;
  }

  module_load_include('inc', 'feature_toggle', 'includes/feature_toggle.api');
  if (feature_toggle_get_status('be_well_informed_sample_data')) {
    $be_well_informed_response = sample_be_well_informed_response();
  } else {
    // TODO: hook into be well informed app
    $be_well_informed_response = array();
  }


  drupal_json_output(array('error' => false, 'data' => $be_well_informed_response));
}

function be_well_informed_datatable_response($be_well_response) {
  $datatable_json = [];
  foreach($be_well_response as $water_data) {
    $datatable_row = [];
    $datatable_row[] = $water_data['name'];
    $datatable_row[] = $water_data['input'];
    $datatable_row[] = $water_data['containment_level'];
    $datatable_row[] = $water_data['message'];
    $datatable_row[] = $water_data['level'];
    $datatable_json[] = $datatable_row;
  }

  return $datatable_json;
}


function sample_be_well_informed_response() {
  $response = [
    [
      'name' => 'Arsenic',
      'input' => '0.01 mg/L',
      'containment_level' => '0.01 mg/L',
      'message' => 'The value entered is close to exceeding the drinking water standard',
      'level' => 'close',
    ],
    [
      'name' => 'Chloride',
      'input' => 'None',
      'containment_level' => '250 mg/L',
      'message' => 'A value was not entered',
      'level' => 'none',
    ],
    [
      'name' => 'Copper',
      'input' => '1.3 mg/L',
      'containment_level' => '1.3 mg/L',
      'message' => 'The value entered meets the drinking water guideline',
      'level' => 'below',
    ],
  ];
  return $response;
}
