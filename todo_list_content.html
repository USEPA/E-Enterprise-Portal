<div class="page-header">
	<h3>To Do List - <span class="month-year"></span></h3>
	<br/>
	<div class="form-inline">
		<div class="btn-group">
			<button class="btn" data-calendar-nav="prev"><< Prev</button>
			<button class="btn btn-default" data-calendar-nav="today">Today</button>
			<button class="btn" data-calendar-nav="next">Next >></button>
		</div>		
	</div>	
</div>

<table class="table table-striped" id="task-list-table">
	<thead>
	  <tr>
		<th>Task</th>
		<th class="text-center">Alert Date</th>
        <th>Status</th>
		<th class="text-center">View Details</th>
		<th class="text-center">Set Alert</th>
		<th class="text-center">Ignore</th>
		<th class="text-center">Done</th>
	  </tr>
	</thead>
	<tbody> 
	</tbody>
</table>
<hr/>

<div class="btn-group">
	<button class="btn" data-calendar-view="year">Year</button>
	<button class="btn" data-calendar-view="month">Month</button>
	<button class="btn" data-calendar-view="week">Week</button>
	<button class="btn" data-calendar-view="day">Day</button>
</div>

<div id="calendar"></div>

<br />
<a href="javascript:;">Task Archive</a>

<script src="Content/js/underscore-min.js"></script>
<script type="text/javascript" src="Content/js/calendar.js"></script>
<script type="text/javascript">
    Date.prototype.customFormat = function (formatString) {
        var YYYY, YY, MMMM, MMM, MM, M, DDDD, DDD, DD, D, hhh, hh, h, mm, m, ss, s, ampm, AMPM, dMod, th;
        var dateObject = this;
        YY = ((YYYY = dateObject.getFullYear()) + "").slice(-2);
        MM = (M = dateObject.getMonth() + 1) < 10 ? ('0' + M) : M;
        MMM = (MMMM = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"][M - 1]).substring(0, 3);
        DD = (D = dateObject.getDate()) < 10 ? ('0' + D) : D;
        DDD = (DDDD = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"][dateObject.getDay()]).substring(0, 3);
        th = (D >= 10 && D <= 20) ? 'th' : ((dMod = D % 10) == 1) ? 'st' : (dMod == 2) ? 'nd' : (dMod == 3) ? 'rd' : 'th';
        formatString = formatString.replace("#YYYY#", YYYY).replace("#YY#", YY).replace("#MMMM#", MMMM).replace("#MMM#", MMM).replace("#MM#", MM).replace("#M#", M).replace("#DDDD#", DDDD).replace("#DDD#", DDD).replace("#DD#", DD).replace("#D#", D).replace("#th#", th);

        h = (hhh = dateObject.getHours());
        if (h == 0) h = 24;
        if (h > 12) h -= 12;
        hh = h < 10 ? ('0' + h) : h;
        AMPM = (ampm = hhh < 12 ? 'am' : 'pm').toUpperCase();
        mm = (m = dateObject.getMinutes()) < 10 ? ('0' + m) : m;
        ss = (s = dateObject.getSeconds()) < 10 ? ('0' + s) : s;
        return formatString.replace("#hhh#", hhh).replace("#hh#", hh).replace("#h#", h).replace("#mm#", mm).replace("#m#", m).replace("#ss#", ss).replace("#s#", s).replace("#ampm#", ampm).replace("#AMPM#", AMPM);
    }

    $(document).ready(function () {
        $('.btn-group button[data-calendar-nav]').each(function () {
            var $this = $(this);
            $this.click(function () {
                calendar.navigate($this.data('calendar-nav'));
            });
        });

        $('.btn-group button[data-calendar-view]').each(function () {
            var $this = $(this);
            $this.click(function () {
                calendar.view($this.data('calendar-view'));
            });
        });
    });

    function setTaskList(tasks, startTime, endTime) {
        var taskListBody = $('#task-list-table tbody');

        taskListBody.html('');

        $.each(tasks, function (index, value) {
            var showUrl = false;
            if (value.url != null || value.url != undefined) {
                showUrl = true;
            }

            urlTarget = '_blank';
            if (value.target != undefined) {
                urlTarget = value.target;
            }

            var tableRow = '<tr data-task-id="' + value.id + '" data-task-guid="' + value.guid + '">';
            tableRow += '<td>' + value.title + '</td>';
            var date = new Date(value.start);
            tableRow += '<td class="text-center">' + date.customFormat('#MM#/#DD#/#YYYY#') + '</td>';
            tableRow += '<td>' + value.status + '</td>';
            tableRow += '<td class="text-center"><a href="' + value.url + '" target="' + urlTarget + '"><i class="fa fa-folder-open fa-2"></i></a></td>';
            tableRow += '<td class="text-center"><a href="#"><i class="fa fa-calendar"></i></a></td>';
            tableRow += '<td class="text-center"><a href="#" class="task-ignore"><i class="fa fa-times"></i></a></td>';
            tableRow += '<td class="text-center"><a href="#" class="task-complete"><i class="fa fa-check-square"></i></a></td>';
            tableRow += '</tr>';

            taskListBody.append(tableRow);
        });

        if (tasks.length <= 0) {
            var startDate = new Date(startTime);
            var endDate = new Date(endTime);
            endDate.setDate(endDate.getDate() - 1);

            var msg = 'There are no tasks to list for ' + startDate.customFormat('#MM#/#DD#/#YYYY#') + ' - ' + endDate.customFormat('#MM#/#DD#/#YYYY#');
            taskListBody.append('<tr><td colspan="7"><b>' + msg + '</b></td></tr>');
        }

        //Bind task events
        $('.task-complete').unbind().click(function (e) {
            $(this).closest('tr').remove();
            var taskId = $(this).closest('tr').data('taskId');
            var tmpEvents = [];

            $.each(eventsSource, function (index, value) {
                if (taskId != value.id) {
                    tmpEvents.push(value);
                }
            });

            eventsSource = tmpEvents;
            calendar.view();

            e.preventDefault();
            return false;
        });

        $('.task-ignore').unbind().click(function (e) {
            var ignoreTask = confirm('Are you sure you want to ignore this task?');

            var taskId = $(this).closest('tr').data('taskId');

            if (ignoreTask === true) {
                $(this).closest('tr').remove();
                var tmpEvents = [];

                $.each(eventsSource, function (index, value) {
                    if (taskId != value.id) {
                        tmpEvents.push(value);
                    }
                });

                eventsSource = tmpEvents;
                calendar.view();
            }
            e.preventDefault();
            return false;
        });
    }

    var eventsSource = [
		{
			"id": 293,
			"title": "TRI Version 6 Released.",
			"url": "http://www.exchangenetwork.net/news/tri-version-6-0-released-2",
			"class": 'event-important',
			"start": 1417638064000, // Milliseconds
			"end": 1417641664000  // Milliseconds
		},
		{
			"id": 294,
			"title": "Public comment period on National Emissions Standards for Hazardous Air Pollutants: Secondary Aluminum Production ends.",
			"url": "http://www.regulations.gov/#!documentDetail;D=EPA-HQ-OAR-2010-0544-0213",
			"class": 'event-info',
			"start": 1418070064000, // Milliseconds
			"end": 1418073664000  // Milliseconds
		},
		{
			"id": 295,
			"title": "EPA Administrator to Deliver Remarks at Two Events at the National Press Club.",
			"url": "http://yosemite.epa.gov/opa/admpress.nsf/9335cfcd942ef57f8525735900404439/c9ece7d0c541007185257da8006bca76!OpenDocument",
			"class": 'event-info',
			"start": 1418084464000, // Milliseconds
			"end": 1418088064000  // Milliseconds
		},
		{
			"id": 296,
			"title": "Refinery Safety Forum.",
			"url": "http://www.calepa.ca.gov/Refinery/Meetings/2014/Bakersfield.pdf",
			"class": 'event-info',
			"start": 1418916064000, // Milliseconds
			"end": 1418919664000  // Milliseconds
		},
		{
			"id": 297,
			"title": "Toxic Release Inventory (TRI) Reporting Period begins.",
			"class": 'event-important',
			"start": 1420129264000, // Milliseconds
			"end": 1420132864000  // Milliseconds
		},
		{
			"id": 298,
			"title": "EPA/NIEHS Children's Centers 2015 Webinar Series â€“ Session 1.",
			"class": 'event-info',
			"start": 1421256064000, // Milliseconds
			"end": 1421259664000  // Milliseconds
		},
		{
			"id": 299,
			"title": "NPDES Permit #SDR100000 expires.",
			"url": "http://cfpub.epa.gov/npdes/permitissuance/genpermits_a.cfm?dir=ASC&CFID=179139869&CFTOKEN=90890676&jsessionid=4e307faab7a26b4338745859412a4a456817",
			"class": 'event-important',
			"start": 1422728464000, // Milliseconds
			"end": 1422732064000  // Milliseconds
		},
		{
			"id": 300,
			"title": "NPDES Permit# PA0012777 expires in 90 days.",
			"url": "http://www.pabulletin.com/secure/data/vol37/37-50/2312.html",
			"class": 'event-important',
			"start": 1422818464000, // Milliseconds
			"end": 1422822064000  // Milliseconds
		},
		{
			"id": 301,
			"title": "2015 Climate Leadership Awards and Conference.",
			"url": "http://www.epa.gov/climateleadership/awards/dinner.html",
			"class": 'event-info',
			"start": 1424722864000, // Milliseconds
			"end": 1424726464000  // Milliseconds
		},
		{
			"id": 302,
			"title": "IRIS Bimonthly Public Science Meeting.",
			"url": "http://www.epa.gov/iris/publicmeeting/iris_bimonthly-feb2015/",
			"class": 'event-info',
			"start": 1424899264000, // Milliseconds
			"end": 1424902864000  // Milliseconds
		},
		{
			"id": 303,
			"title": "Waste Discharge Permit - Effluent Limits report is ready for review.",
			"url": "workspace.html#Environmental%20Dashboard",
			"class": 'event-important',
			"start": 1420053774000, // Milliseconds
			"end": 1420057374000,  // Milliseconds
			"target": "_self"
		}
	];

//var eventsSource = @Html.Raw(serializer.Serialize(Model.SerializedToDoListItems));

var calendar = $('#calendar').calendar({
    tmpl_path: "Content/tmpls/",
    events_source: function () {
        return eventsSource;
    },
    onAfterViewLoad: function (view) {
        var startDate = this.getStartDate();
        var endDate = this.getEndDate();
        setTaskList(this.getEventsBetween(startDate, endDate), startDate, endDate);

        $('.page-header h3 span.month-year').text(this.getTitle());
        $('.btn-group button').removeClass('active');
        $('button[data-calendar-view="' + view + '"]').addClass('active');
    },
    classes: {
        months: {
            general: 'label'
        }
    }
});			
</script>